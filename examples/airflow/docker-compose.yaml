# elevata â€“ Airflow example
# Optional orchestration setup using Apache Airflow.
#
# This file is provided as an example and is not required for elevata usage.


x-airflow-common: &airflow-common
  build:
    context: ../..
    dockerfile: examples/airflow/Dockerfile
    args:
      ELEVATA_REQ_BASE: requirements/base.txt
      ELEVATA_REQ_BACKEND: requirements/duckdb.txt

  environment:
    TZ: ${TZ:-UTC}

    # --- Airflow core ---
    AIRFLOW__CORE__EXECUTOR: LocalExecutor
    AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@postgres/airflow
    AIRFLOW__CORE__LOAD_EXAMPLES: "false"
    AIRFLOW__WEBSERVER__EXPOSE_CONFIG: "true"
    AIRFLOW__CORE__AUTH_MANAGER: airflow.providers.fab.auth_manager.fab_auth_manager.FabAuthManager
    AIRFLOW__CORE__DEFAULT_TIMEZONE: Europe/Berlin
    AIRFLOW__WEBSERVER__DEFAULT_UI_TIMEZONE: Europe/Berlin

    # --- Admin user for FAB (created by airflow-init) ---
    AIRFLOW_ADMIN_USER: ${AIRFLOW_ADMIN_USER:-admin}
    AIRFLOW_ADMIN_PASSWORD: ${AIRFLOW_ADMIN_PASSWORD:-admin}
    AIRFLOW_ADMIN_EMAIL: ${AIRFLOW_ADMIN_EMAIL:-admin@example.com}

    # --- Optional: set a predictable DAG folder ---
    AIRFLOW__CORE__DAGS_FOLDER: /opt/airflow/dags

    # --- elevata defaults used by the example DAG ---
    ELEVATA_PROFILE: ${ELEVATA_PROFILE:-dev}
    ELEVATA_TARGET_SYSTEM: ${ELEVATA_TARGET_SYSTEM:-dwh}
    ELEVATA_CMD: ${ELEVATA_CMD:-python manage.py}

    # Optional: staleness warning threshold
    ELEVATA_MANIFEST_MAX_AGE_HOURS: ${ELEVATA_MANIFEST_MAX_AGE_HOURS:-24}

  volumes:
    # DAGs
    - ./dags:/opt/airflow/dags:ro

    # Mount elevata repo
    - ../..:/opt/elevata:rw

  working_dir: /opt/elevata/core
  user: "${AIRFLOW_UID:-50000}:0"
  depends_on:
    postgres:
      condition: service_healthy

services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: airflow
      POSTGRES_PASSWORD: airflow
      POSTGRES_DB: airflow
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "airflow"]
      interval: 5s
      retries: 10
    volumes:
      - airflow_pgdata:/var/lib/postgresql/data

  airflow-init:
    <<: *airflow-common
    entrypoint: /bin/bash
    command:
      - -c
      - |
        set -euo pipefail
        airflow db migrate
        airflow users create \
          --username admin \
          --password admin \
          --firstname Admin \
          --lastname User \
          --role Admin \
          --email admin@example.com
    restart: "no"

  airflow-webserver:
    <<: *airflow-common
    command: airflow api-server
    ports:
      - "8080:8080"
    depends_on:
      airflow-init:
        condition: service_completed_successfully

  airflow-dag-processor:
    <<: *airflow-common
    command: airflow dag-processor
    depends_on:
      airflow-init:
        condition: service_completed_successfully

  airflow-scheduler:
    <<: *airflow-common
    command: airflow scheduler
    depends_on:
      airflow-init:
        condition: service_completed_successfully

  airflow-triggerer:
    <<: *airflow-common
    command: airflow triggerer
    depends_on:
      airflow-init:
        condition: service_completed_successfully

volumes:
  airflow_pgdata:
