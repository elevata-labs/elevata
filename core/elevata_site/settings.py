"""
elevata - Metadata-driven Data Platform Framework
Copyright © 2025-2026 Ilona Tag

This file is part of elevata.

elevata is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as
published by the Free Software Foundation, either version 3 of
the License, or (at your option) any later version.

elevata is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with elevata. If not, see <https://www.gnu.org/licenses/>.

Contact: <https://github.com/elevata-labs/elevata>.
"""

"""
Django settings for elevata_site project.

Generated by 'django-admin startproject' using Django 5.2.7.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/5.2/ref/settings/
"""

from pathlib import Path
import os
from dotenv import load_dotenv, find_dotenv 
import dj_database_url
from utils.env import env_bool, env_list, env_str, env_int
from utils.db import build_metadata_database_url

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent
load_dotenv(find_dotenv(filename=".env", raise_error_if_not_found=False))

ELEVATA_VERSION = "1.4.0"

ELEVATA_PROFILES_PATH = os.getenv("ELEVATA_PROFILES_PATH", str((BASE_DIR.parent / "config" / "elevata_profiles.yaml")))

STATIC_URL = "static/"

STATICFILES_DIRS = [
  BASE_DIR / "static", 
  BASE_DIR.parent / "docs",
]

DOCS_BACKENDS_URL = "https://github.com/elevata-labs/elevata/blob/main/docs/source_backends.md"

# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/5.2/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = os.getenv("SECRET_KEY", "dev-only-unsafe")

ALLOWED_HOSTS = env_list("ALLOWED_HOSTS", [])

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = env_bool("DEBUG", False)
SECRET_KEY = env_str("SECRET_KEY", "dev-only-insecure")

# Application definition

INSTALLED_APPS = [
  'django.contrib.admin',
  'django.contrib.auth',
  'django.contrib.contenttypes',
  'django.contrib.sessions',
  'django.contrib.messages',
  'django.contrib.staticfiles',
  'metadata.apps.MetadataConfig',
]

MIDDLEWARE = [
  # Ensure CommonMiddleware is enabled
  "django.middleware.security.SecurityMiddleware",
  "django.contrib.sessions.middleware.SessionMiddleware",
  "django.middleware.common.CommonMiddleware",
  "django.middleware.csrf.CsrfViewMiddleware",
  "django.contrib.auth.middleware.AuthenticationMiddleware",
  "django.contrib.messages.middleware.MessageMiddleware",
  "django.middleware.clickjacking.XFrameOptionsMiddleware",
  "elevata_site.middleware.LoginRequiredAllMiddleware",
]

APPEND_SLASH = True

ROOT_URLCONF = 'elevata_site.urls'

TEMPLATES = [
  {
    "BACKEND": "django.template.backends.django.DjangoTemplates",
    "DIRS": [BASE_DIR / "templates"],
    "APP_DIRS": True,
    "OPTIONS": {
      "context_processors": [
        "django.template.context_processors.debug",
        "django.template.context_processors.request",
        "django.contrib.auth.context_processors.auth",
        "django.contrib.messages.context_processors.messages",
        "elevata_site.context_processors.app_menu",
        "elevata_site.context_processors.type_support",
        "elevata_site.context_processors.crud_ui_config",
        "elevata_site.context_processors.elevata_version",
        "elevata_site.context_processors.sql_dialect_context",
      ],
      "string_if_invalid": "",
    },
  },
]


WSGI_APPLICATION = 'elevata_site.wsgi.application'


# Database
# https://docs.djangoproject.com/en/5.2/ref/settings/#databases

DATABASE_URL = build_metadata_database_url(BASE_DIR)

DATABASES = {
  "default": dj_database_url.parse(
    DATABASE_URL,
    conn_max_age=env_int("DB_CONN_MAX_AGE", 60),
    ssl_require=env_bool("DB_SSL_REQUIRE", False),
  )
}

# Password validation
# https://docs.djangoproject.com/en/5.2/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
  {
    'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
  },
  {
    'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
  },
  {
    'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
  },
  {
    'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
  },
]


# Internationalization
# https://docs.djangoproject.com/en/5.2/topics/i18n/

LANGUAGE_CODE = 'en-us'

TIME_ZONE = 'UTC'

USE_I18N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/5.2/howto/static-files/

STATIC_URL = 'static/'

# Default primary key field type
# https://docs.djangoproject.com/en/5.2/ref/settings/#default-auto-field

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

ELEVATA_CRUD = {
  "metadata": {
    "order": [
      "Team", 
      "Person", 
      "PartialLoad", 
      "System", 
      "SourceDataset", 
      "SourceDatasetGroup",
      "SourceColumn",
      "TargetSchema", 
      "TargetDataset", 
      "TargetColumn", 
      ],
    "descriptions": {
      "Team": "Organize data teams and functional groups.",
      "Person": "Track users and their association with data teams across the organization.",
      "PartialLoad": "Define additional loads to process subsets of datasets at individual frequencies.",
      "System": "Register and describe systems which can be targets or upstream systems that provide raw data to the platform.",
      "SourceDataset": "Define datasets extracted from source systems — the entry point for ingestion.",
      "SourceDatasetGroup": "Group structurally similar source datasets to enable unified target generation.",
      "SourceColumn": "Capture technical metadata and profiling details for each source column.",
      "TargetSchema": "Model your platform’s architectural layers and their default behaviors.",
      "TargetDataset": "Design target datasets and map them to their corresponding source inputs.",
      "TargetColumn": "Define business-ready columns and manage data quality at the attribute level.",
    },
    "icons": {
      "Team": "users",
      "Person": "user",
      "PartialLoad": "timer",
      "System": "database",
      "SourceDataset": "file",
      "SourceDatasetGroup": "merge",
      "SourceColumn": "grid-2x2",
      "TargetSchema": "layers",
      "TargetDataset": "file-check-2",
      "TargetColumn": "grid-2x2-check",
    },
    "exclude": [
      "SourceDatasetOwnership", 
      "TargetDatasetOwnership", 
      "SourceDatasetIncrementPolicy",
      "SourceDatasetGroupMembership",
      "QueryNode",
      "QuerySelectNode",
      "QueryAggregateNode",
      "QueryAggregateGroupKey",
      "QueryAggregateMeasure",
      "OrderByExpression",
      "OrderByItem",
      "QueryUnionNode",
      "QueryUnionOutputColumn",
      "QueryUnionBranch",
      "QueryUnionBranchMapping",
      "QueryWindowNode",
      "QueryWindowColumnArg",
      "PartitionByExpression",
      "PartitionByItem",
      "QueryWindowColumn",
      "TargetDatasetInput",
      "TargetColumnInput",
      "TargetDatasetJoin",
      "TargetDatasetJoinPredicate",
      "TargetDatasetReference",
      "TargetDatasetReferenceComponent",
    ],
    "paths": {      
    },
    "system_managed": {
      "TargetSchema": [
        "short_name",
        "database_name",
        "schema_name",
        "physical_prefix",
        "generate_layer",
        "is_user_visible",
        "default_materialization_type",
        "default_historize",
        "incremental_strategy_default",
        "surrogate_keys_enabled",
        "surrogate_key_algorithm",
        "surrogate_key_null_token",
        "surrogate_key_pair_separator",
        "surrogate_key_component_separator",
        "pepper_strategy",
      ],
      "TargetDataset": [
        "target_schema",
        "target_dataset_name",
        "incremental_strategy",
        "incremental_source",
        "handle_deletes",
        "historize",
        "source_datasets",
        "upstream_datasets",
        "combination_mode",
        "biz_entity_role",
        "biz_grain_note",
        "manual_model",
        "distinct_select",
        "static_filter",
        "query_root",
        "query_head",
        "active",
        "retired_at",
      ],
      "TargetColumn": [
        "target_dataset",
        "target_column_name",
        "ordinal_position",
        "source_columns",
        "upstream_columns",
        "datatype",
        "max_length",
        "decimal_precision",
        "decimal_scale",
        "nullable",
        "system_role",
        "manual_expression",
        "lineage_origin",
        "surrogate_expression",
        "active",
        "retired_at",
      ],
      "schema_overrides": {
        "raw": {
          "TargetColumn": {
            "unlock": [
              "active",
            ],
          },
        },
        "stage": {
          "TargetColumn": {
            "unlock": [
              "active",
            ],
          },
        },
        "rawcore": {
          "TargetDataset": {
            "unlock": [
              "target_dataset_name",
              "handle_deletes",
              "historize",
              "manual_model",
              "distinct_select",
              "static_filter",
              "active",
            ],
          },
          "TargetColumn": {
            "unlock": [
              "target_column_name",
              "datatype",
              "max_length",
              "decimal_precision",
              "decimal_scale",
              "nullable",
              "manual_expression",
              "active",
            ],
          },
        },
      },
      # schema-level readonly fields (independent of is_system_managed)
      "schema_readonly": {
        "bizcore": {
          "TargetDataset": [
            "manual_model",
            "incremental_source",
            "source_datasets",
          ],
          "TargetColumn": [
            "source_columns",
          ],
        },
        "serving": {
          "TargetDataset": [
            "manual_model",
            "incremental_source",
            "source_datasets",
          ],
          "TargetColumn": [
          ],
        },
      }, 
    },
    "no_create": [
      "TargetSchema"
    ],
    "dynamic_choices": {
      "SourceDatasetGroup": {
        "target_short_name": {
          "model": "System",
          "field": "target_short_name",
          "placeholder": "— choose a target —"
        }
      }
    },
    "list_toggle_fields": {
      "System": [
        {
          "field": "generate_raw_tables",
          "label_on": "Raw Tables",
          "label_off": "Raw Tables",
          "title": "Generate Raw Tables"
        },
      ],
      "SourceDataset": [
        {
          "field": "integrate",
          "label_on": "Integrate",
          "label_off": "Integrate",
          "title": "Mark dataset for integration"
        },
      ],
      "SourceColumn": [
        {
          "field": "integrate",
          "label_on": "Integrate",
          "label_off": "Integrate",
          "title": "Mark column for integration"
        },
      ],
      "SourceDatasetGroupMembership": [
        {
          "field": "is_primary_system",
          "label_on": "Primary",
          "label_off": "Primary",
          "title": "Primary system",
        },
      ],
      "SourceDatasetOwnership": [
        {
          "field": "is_primary_owner",
          "label_on": "Primary",
          "label_off": "Primary",
          "title": "Primary accountable owner",
        },
      ],
      "TargetColumn": [
        {
          "field": "nullable",
          "label_on": "Nullable",
          "label_off": "Nullable",
          "title": "Mark column as nullable"
        },
      ],
      "TargetDatasetOwnership": [
        {
          "field": "is_primary_owner",
          "label_on": "Primary",
          "label_off": "Primary",
          "title": "Primary accountable owner",
        },
      ],
    },
    "badges": {
      "System": [
        {
          "field": "is_source", 
          "class_map": {
            "True": "badge badge-sk",
            "False": "",
            "default": "",
          },
          "label_map": {
            "True": "Source",
            "False": "",
            "default": "",
          },
        },
        {
          "field": "is_target", 
          "class_map": {
            "True": "badge badge-pii-low",
            "False": "",
            "default": "",
          },
          "label_map": {
            "True": "Target",
            "False": "",
            "default": "",
          },
        },
        {
          "field": "active", 
          "class_map": {
            "True": "",
            "False": "badge badge-health-warning",
            "default": "",
          },
          "label_map": {
            "True": "",
            "False": "Retired",
            "default": "",
          },
        },
      ],
      "SourceDataset": [
        {
          "field": "active", 
          "class_map": {
            "True": "",
            "False": "badge badge-health-warning",
            "default": "",
          },
          "label_map": {
            "True": "",
            "False": "Retired",
            "default": "",
          },
          "field": "has_no_missing_increment_policies",
          "class_map": {
            "True": "",
            "False": "badge bg-danger",
            "default": "",
          },
          "label_map": {
            "True": "",
            "False": "missing increment policies",
            "default": "",
          },
        },
      ],
      "SourceColumn": [
        {
          "field": "primary_key_column", 
          "class_map": {
            "True": "badge badge-sk",
            "False": "",
            "default": "",
          },
          "label_map": {
            "True": "PK",
            "False": "",
            "default": "",
          },
        },
        {
          "field": "pii_level",
          "class_map": {
            "special_category_data": "badge badge-pii-high",
            "personal_data": "badge badge-pii-medium",
            "none": "badge badge-pii-none",
            "default": "badge badge-pii-none",
          },
          "label_map": {
            "special_category_data": "Special",
            "personal_data": "Personal",
            "none": "",
            "default": "",
          },
        },
      ],
      "TargetDataset": [
        {
          "field": "historize", 
          "class_map": {
            "True": "badge badge-sk",
            "False": "",
            "default": "",
          },
          "label_map": {
            "True": "Historize",
            "False": "",
            "default": "",
          },
        },
        {
          "field": "incremental_strategy", 
          "class_map": {
            "append": "badge badge-pk",
            "merge": "badge badge-pk",
            "snapshot": "badge badge-pk",
            "full": "",
          },
          "label_map": {
            "append": "Append",
            "merge": "Merge",
            "snapshot": "Snapshot",
            "full": "",
          },
        },
        {
          "field": "active", 
          "class_map": {
            "True": "",
            "False": "badge badge-health-warning",
            "default": "",
          },
          "label_map": {
            "True": "",
            "False": "Retired",
            "default": "",
          },
        },
        {
          "field": "sensitivity",
          "class_map": {
            "highly_confidential": "badge badge-pii-high",
            "confidential": "badge badge-pii-medium",
            "internal": "badge badge-pii-low",
            "public": "badge badge-pii-none",
          },
          "label_map": {
            "highly_confidential": "Highly Conf",
            "confidential": "Confidential",
            "internal": "Internal",
            "public": "",
          },
        },
      ],
      "TargetColumn": [
        {
          "field": "system_role", 
          "class_map": {
            "surrogate_key": "badge badge-sk",
            "foreign_key": "badge badge-fk",
            "business_key": "badge badge-pk",
            "entity_key": "badge badge-fk",
            "row_hash": "",
            "payload": "",
            "load_run_id": "",
            "loaded_at": "",
            "version_started_at": "",
            "version_ended_at": "",
            "version_state": "",
            "": "",
          },
          "label_map": {
            "surrogate_key": "SK",
            "foreign_key": "FK",
            "business_key": "BK",
            "entity_key": "EK",
            "row_hash": "",
            "payload": "",
            "load_run_id": "",
            "loaded_at": "",
            "version_started_at": "",
            "version_ended_at": "",
            "version_state": "",
            "": "",
          },
        },
        {
          "field": "pii_level",
          "class_map": {
            "special_category_data": "badge badge-pii-high",
            "personal_data": "badge badge-pii-medium",
            "none": "badge badge-pii-none",
            "default": "badge badge-pii-none",
          },
          "label_map": {
            "special_category_data": "Special",
            "personal_data": "Personal",
            "none": "",
            "default": "",
          },
        },
        {
          "field": "active", 
          "class_map": {
            "True": "",
            "False": "badge badge-health-warning",
            "default": "",
          },
          "label_map": {
            "True": "",
            "False": "Retired",
            "default": "",
          },
        },
        {
          "field": "sensitivity",
          "class_map": {
            "highly_confidential": "badge badge-pii-high",
            "confidential": "badge badge-pii-medium",
            "internal": "badge badge-pii-low",
            "public": "badge badge-pii-none",
          },
          "label_map": {
            "highly_confidential": "Highly Conf",
            "confidential": "Confidential",
            "internal": "Internal",
            "public": "",
          },
        },
      ],
      "TargetDataset": [
        {
          "field": "has_incomplete_joins",
          "class_map": {
            "True": "badge bg-danger",
            "False": "",
            "default": "",
          },
          "label_map": {
            "True": "Missing joins",
            "False": "",
            "default": "",
          },
        },
      ],
      "TargetDatasetJoin": [
        {
          "field": "has_missing_predicates",
          "class_map": {
            "True": "badge bg-danger",
            "False": "",
            "default": "",
          },
          "label_map": {
            "True": "Missing predicates",
            "False": "",
            "default": "",
          },
        },
      ],
      "TargetDatasetReference": [
        {
          "field": "has_incomplete_bk_components",
          "class_map": {
            "True": "badge bg-danger",
            "False": "",
            "default": "",
          },
          "label_map": {
            "True": "BK incomplete",
            "False": "",
            "default": "",
          },
        },
      ],
    },
    "ui": {
      "defaults": {
        "list": {
          "exclude_fields": [
            "id", "created_at", "created_by", "updated_at", "updated_by",
            "is_system_managed", "lineage_key", "former_names", "retired_at",
          ],
        },
        "form": {
          "exclude_fields": [
            "id", "created_at", "created_by", "updated_at", "updated_by",
            "is_system_managed", "lineage_key", "former_names", "retired_at"
          ],
        },
      },
      "models": {
        "TargetSchema": {
          "form": {
            "include_fields": [
              "short_name",
              "display_name",
              "description",
              "sensitivity_default",
              "access_intent_default",
            ]
          }
        },
        "TargetDataset": {
          "list": {
            "include_fields": [
              "target_schema", 
              "target_dataset_name",
              "description",
              "handle_deletes",
              "historize",
              "combination_mode",
              "biz_entity_role",
              "biz_grain_note",
              "incremental_strategy",
              "manual_model",
              "distinct_select",
              "static_filter",
              "materialization_type",
              "sensitivity",
              "access_intent",
              "active",
            ],
          },
          "form": {
            "include_fields": [
              "target_schema", 
              "target_dataset_name",
              "description",
              "handle_deletes",
              "historize",
              "upstream_datasets",
              "combination_mode",
              "biz_entity_role",
              "biz_grain_note",
              "incremental_strategy",
              "manual_model",
              "distinct_select",
              "static_filter",
              "partial_load",
              "owner",
              "materialization_type",
              "sensitivity",
              "access_intent",
              "active",
            ],
          },
        },
        "TargetDatasetInput": {
          "list": {
            "include_fields": [
              "target_dataset",
              "source_dataset",
              "upstream_target_dataset",
              "role",
              "active",
            ],
          },
          "form": {
            "include_fields": [
              "role",
            ],
          },
        },
        "TargetColumn": {
          "list": {
            "include_fields": [
              "target_dataset",
              "target_column_name",
              "ordinal_position",
              "datatype",
              "max_length",
              "decimal_precision",
              "decimal_scale",
              "nullable",
              "system_role",
              "manual_expression",
              "description",
              "pii_level",
              "remark",
              "sensitivity",
              "lineage_origin",
              "surrogate_expression",
              "active",
            ],
          },
          "form": {
            "include_fields": [
              "target_dataset",
              "target_column_name",
              "ordinal_position",
              "upstream_columns",
              "datatype",
              "max_length",
              "decimal_precision",
              "decimal_scale",
              "nullable",
              "manual_expression",
              "description",
              "pii_level",
              "remark",
              "sensitivity",
              "lineage_origin",
              "profiling_stats",
              "active",
            ],
          },
        },
      },
    }
  }
}

LOGIN_URL = "/accounts/login/"
LOGIN_REDIRECT_URL = "/"
LOGOUT_REDIRECT_URL = "/accounts/login/"
PASSWORD_CHANGE_REDIRECT_URL = "/"
