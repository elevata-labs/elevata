# Generated by Django 5.2.7 on 2026-01-22 18:14

import django.core.validators
import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='OrderByExpression',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True, db_index=True)),
                ('name', models.CharField(help_text="Label used in the UI (e.g. 'By Date Desc', 'By Customer, Date').", max_length=128)),
                ('active', models.BooleanField(default=True, help_text='Whether this ORDER BY definition is active and used by referencing expressions.')),
                ('created_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('updated_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'db_table': 'order_by_expression',
            },
        ),
        migrations.CreateModel(
            name='PartialLoad',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True, db_index=True)),
                ('name', models.CharField(help_text='Short code for this partial load. Will be displayed as the load pipeline name.', max_length=10, unique=True, validators=[django.core.validators.RegexValidator(message='Must start with a lowercase letter and contain only lowercase letters and digits. Max length is 10 characters.', regex='^[a-z][a-z0-9]{0,9}$')])),
                ('description', models.CharField(blank=True, help_text='Optional description which purpose this partial load is meant for.', max_length=255, null=True)),
                ('created_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('updated_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name_plural': 'Partial Loads',
                'db_table': 'partial_load',
                'ordering': ['name'],
            },
        ),
        migrations.CreateModel(
            name='PartitionByExpression',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True, db_index=True)),
                ('name', models.CharField(help_text="Label used in the UI (e.g. 'By Customer', 'By Customer + Day').", max_length=128)),
                ('active', models.BooleanField(default=True, help_text='Controls whether this PARTITION BY definition can be selected and used in queries.')),
                ('created_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('updated_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'db_table': 'partition_by_expression',
            },
        ),
        migrations.CreateModel(
            name='Person',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True, db_index=True)),
                ('email', models.EmailField(help_text='Email address. Used as the unique identifier of this person.', max_length=254, unique=True)),
                ('name', models.CharField(help_text='Full name of the person.', max_length=200)),
                ('created_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('updated_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name_plural': 'People',
                'db_table': 'person',
                'ordering': ['email'],
            },
        ),
        migrations.CreateModel(
            name='QueryNode',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True, db_index=True)),
                ('node_type', models.CharField(choices=[('select', 'Select'), ('aggregate', 'Aggregate'), ('union', 'Union'), ('window', 'Window'), ('cte', 'CTE')], help_text='Type of query operator represented by this node.', max_length=16)),
                ('name', models.CharField(blank=True, default='', help_text="Optional label for UI (e.g. 'Base Select', 'Agg: Daily', 'Union: Sources').", max_length=128)),
                ('active', models.BooleanField(default=True, help_text='Enable/disable this query node. Disabled nodes are ignored by the builder.')),
                ('created_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('updated_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'db_table': 'query_node',
            },
        ),
        migrations.CreateModel(
            name='QueryAggregateNode',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True, db_index=True)),
                ('mode', models.CharField(choices=[('grouped', 'Grouped'), ('global', 'Global')], default='grouped', help_text='Grouped requires group keys; Global allows measures without group keys.', max_length=16)),
                ('created_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('updated_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('input_node', models.ForeignKey(help_text='Input query node providing rows to aggregate (wrapped as subquery).', on_delete=django.db.models.deletion.PROTECT, related_name='used_as_aggregate_input', to='metadata.querynode')),
                ('node', models.OneToOneField(help_text='Query node header for this AGGREGATE operator.', limit_choices_to={'node_type': 'aggregate'}, on_delete=django.db.models.deletion.CASCADE, related_name='aggregate', to='metadata.querynode')),
            ],
            options={
                'verbose_name': 'Query aggregate node',
                'verbose_name_plural': 'Query aggregate nodes',
                'db_table': 'query_aggregate_node',
            },
        ),
        migrations.CreateModel(
            name='QuerySelectNode',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True, db_index=True)),
                ('use_dataset_definition', models.BooleanField(default=True, help_text='When true, build select from owning TargetDataset definition (joins/columns/manual expressions).')),
                ('created_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('node', models.OneToOneField(help_text='Query node header for this SELECT operator.', limit_choices_to={'node_type': 'select'}, on_delete=django.db.models.deletion.CASCADE, related_name='select', to='metadata.querynode')),
                ('updated_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Query select node',
                'verbose_name_plural': 'Query select nodes',
                'db_table': 'query_select_node',
            },
        ),
        migrations.CreateModel(
            name='QueryUnionNode',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True, db_index=True)),
                ('mode', models.CharField(choices=[('union', 'UNION'), ('union_all', 'UNION ALL')], default='union_all', help_text='UNION removes duplicates, UNION ALL keeps duplicates (faster).', max_length=16)),
                ('created_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('node', models.OneToOneField(help_text='Query node header for this UNION operator.', limit_choices_to={'node_type': 'union'}, on_delete=django.db.models.deletion.CASCADE, related_name='union', to='metadata.querynode')),
                ('updated_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Query union node',
                'verbose_name_plural': 'Query union nodes',
                'db_table': 'query_union_node',
            },
        ),
        migrations.CreateModel(
            name='QueryUnionBranch',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True, db_index=True)),
                ('ordinal_position', models.PositiveIntegerField(default=0, help_text='Ordering of UNION branches in UI and generated SQL.')),
                ('created_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('input_node', models.ForeignKey(help_text='Branch query node producing rows to union.', on_delete=django.db.models.deletion.PROTECT, related_name='used_as_union_branch', to='metadata.querynode')),
                ('updated_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('union_node', models.ForeignKey(help_text='Union operator this branch belongs to.', on_delete=django.db.models.deletion.CASCADE, related_name='branches', to='metadata.queryunionnode')),
            ],
            options={
                'db_table': 'query_union_branch',
                'unique_together': {('union_node', 'ordinal_position')},
            },
        ),
        migrations.CreateModel(
            name='QueryUnionOutputColumn',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True, db_index=True)),
                ('name', models.CharField(help_text='Output column name of the UNION schema contract.', max_length=255)),
                ('ordinal_position', models.PositiveIntegerField(default=0, help_text='Ordering of output columns in the UNION schema contract.')),
                ('datatype', models.CharField(blank=True, choices=[('BIGINT', 'Big Integer'), ('BINARY', 'Binary'), ('BOOLEAN', 'Boolean'), ('DATE', 'Date'), ('DECIMAL', 'Decimal'), ('FLOAT', 'Float'), ('INTEGER', 'Integer'), ('JSON', 'JSON'), ('STRING', 'String'), ('TIME', 'Time'), ('TIMESTAMP', 'Timestamp'), ('UUID', 'UUID')], help_text='Optional logical datatype of the UNION output column.', max_length=20, null=True)),
                ('created_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('union_node', models.ForeignKey(help_text='Union operator this output column belongs to (schema contract).', on_delete=django.db.models.deletion.CASCADE, related_name='output_columns', to='metadata.queryunionnode')),
                ('updated_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'db_table': 'query_union_output_column',
                'unique_together': {('union_node', 'ordinal_position')},
            },
        ),
        migrations.CreateModel(
            name='QueryWindowNode',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True, db_index=True)),
                ('created_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('input_node', models.ForeignKey(help_text='Input query node providing rows for window functions (wrapped as subquery).', on_delete=django.db.models.deletion.PROTECT, related_name='used_as_window_input', to='metadata.querynode')),
                ('node', models.OneToOneField(help_text='Query node holding window function definitions.', limit_choices_to={'node_type': 'window'}, on_delete=django.db.models.deletion.CASCADE, related_name='window', to='metadata.querynode')),
                ('updated_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Query window node',
                'verbose_name_plural': 'Query window nodes',
                'db_table': 'query_window_node',
            },
        ),
        migrations.CreateModel(
            name='QueryWindowColumn',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True, db_index=True)),
                ('output_name', models.CharField(help_text='Output column name (can be friendly in serving).', max_length=255)),
                ('function', models.CharField(choices=[('ROW_NUMBER', 'ROW_NUMBER'), ('RANK', 'RANK'), ('DENSE_RANK', 'DENSE_RANK'), ('NTILE', 'NTILE'), ('LAG', 'LAG'), ('LEAD', 'LEAD')], help_text='Window function.', max_length=32)),
                ('ordinal_position', models.PositiveIntegerField(default=0, help_text='Position of this window output column in the projection.')),
                ('active', models.BooleanField(default=True, help_text='Whether this window output column is enabled (included in SQL rendering).')),
                ('created_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('order_by', models.ForeignKey(blank=True, help_text='Optional ORDER BY definition (recommended for deterministic results).', null=True, on_delete=django.db.models.deletion.PROTECT, to='metadata.orderbyexpression')),
                ('partition_by', models.ForeignKey(blank=True, help_text='Optional PARTITION BY definition.', null=True, on_delete=django.db.models.deletion.PROTECT, to='metadata.partitionbyexpression')),
                ('updated_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('window_node', models.ForeignKey(help_text='Window operator this output column belongs to.', on_delete=django.db.models.deletion.CASCADE, related_name='columns', to='metadata.querywindownode')),
            ],
            options={
                'db_table': 'query_window_column',
                'unique_together': {('window_node', 'ordinal_position')},
            },
        ),
        migrations.CreateModel(
            name='SourceDataset',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True, db_index=True)),
                ('schema_name', models.CharField(blank=True, help_text='The schema name this dataset resides on. Can be left empty if it is a default schema (eg. dbo in SQLServer).', max_length=50, null=True)),
                ('source_dataset_name', models.CharField(help_text='Original name of the source dataset.', max_length=100)),
                ('description', models.CharField(blank=True, help_text='Optional description of the business content in this dataset.', max_length=255, null=True)),
                ('integrate', models.BooleanField(default=True, help_text='Controls whether this source dataset is in scope for integration into the target platform (stage/rawcore/bizcore/etc.). Uncheck if the dataset is documented here but not yet ready or intentionally excluded from automated target generation.')),
                ('static_filter', models.CharField(blank=True, help_text="Static WHERE clause applied to all loads of this dataset. Used for permanent business or technical scoping. Example: is_deleted_flag = 0 AND country_code = 'DE'.", max_length=255, null=True)),
                ('incremental', models.BooleanField(default=False, help_text='If checked, an incremental load strategy will be applied. In this case, appropriate increment parameters have to be provided.')),
                ('increment_filter', models.CharField(blank=True, help_text='Template WHERE clause for incremental extraction. Use the placeholder {{DELTA_CUTOFF}} for the dynamic cutoff timestamp/date. Example: (last_update_ts >= {{DELTA_CUTOFF}} OR created_at >= {{DELTA_CUTOFF}}) AND is_deleted_flag = 0.', max_length=255, null=True)),
                ('manual_model', models.BooleanField(default=False, help_text='If checked: dataset is manually maintained, not fully auto-generated.')),
                ('distinct_select', models.BooleanField(default=False, help_text='If checked: SELECT DISTINCT is enforced during generation.')),
                ('generate_raw_table', models.BooleanField(default=None, help_text='If Unknown: inherit the setting on SourceSystem level. If Yes: force creation of a raw landing TargetDataset for this SourceDataset. If No: suppress creation of a raw landing TargetDataset.', null=True)),
                ('active', models.BooleanField(default=True, help_text='Indicates whether this dataset is still considered an active source in the originating system. If unchecked, the dataset is treated as retired (no new loads expected) but it remains in metadata for lineage, audit, and historical reference.')),
                ('retired_at', models.DateTimeField(blank=True, help_text='Auto-set when active is unchecked. Used for lineage and audit.', null=True)),
                ('created_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('updated_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name_plural': 'Source Datasets',
                'db_table': 'source_dataset',
                'ordering': ['source_system', 'schema_name', 'source_dataset_name'],
            },
        ),
        migrations.CreateModel(
            name='SourceColumn',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True, db_index=True)),
                ('source_column_name', models.CharField(help_text="Original source column name, eg. 'MANDT', 'VBELN'.", max_length=100)),
                ('ordinal_position', models.PositiveIntegerField(help_text='Column order within the dataset.')),
                ('source_datatype_raw', models.CharField(blank=True, help_text="Raw source datatype as reported by the source introspection (lossless). Example: 'bit', 'nvarchar(max)', 'decimal(18,2)'.", max_length=100, null=True)),
                ('datatype', models.CharField(choices=[('BIGINT', 'Big Integer'), ('BINARY', 'Binary'), ('BOOLEAN', 'Boolean'), ('DATE', 'Date'), ('DECIMAL', 'Decimal'), ('FLOAT', 'Float'), ('INTEGER', 'Integer'), ('JSON', 'JSON'), ('STRING', 'String'), ('TIME', 'Time'), ('TIMESTAMP', 'Timestamp'), ('UUID', 'UUID')], help_text='Logical / normalized datatype.', max_length=20)),
                ('max_length', models.PositiveIntegerField(blank=True, help_text='How many characters the field may have.', null=True)),
                ('decimal_precision', models.PositiveIntegerField(blank=True, help_text='If datatype decimal, the decimal precision of the column.', null=True)),
                ('decimal_scale', models.PositiveIntegerField(blank=True, help_text='If datatype decimal, the number of decimal places of the column.', null=True)),
                ('nullable', models.BooleanField(default=True, help_text='If checked, this column can be NULL in the source dataset.')),
                ('primary_key_column', models.BooleanField(default=False, help_text='If checked, this column is part of the natural/business key (not the surrogate key).')),
                ('referenced_source_dataset_name', models.CharField(blank=True, help_text="Name of the upstream source object this column refers to (e.g. table 'customer_master', API 'GET /customers'). Serves for information purposes, does not necessarily have to be integrated/modeled as a SourceDataset. Used for lineage suggestions and probable future FK generation.", max_length=100, null=True)),
                ('description', models.CharField(blank=True, help_text='Business description / semantic meaning of the column.', max_length=255, null=True)),
                ('integrate', models.BooleanField(default=False, help_text='Controls whether this source column is in scope for integration into the target model. Uncheck, if the column is not (yet) chosen for integration.')),
                ('pii_level', models.CharField(choices=[('none', 'No personal data'), ('personal_data', 'Personal data'), ('special_category_data', 'Special category personal data')], default='none', help_text='PII classification of this column, if applicable.', max_length=30)),
                ('remark', models.CharField(blank=True, help_text='Free-form notes.', max_length=255, null=True)),
                ('created_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('updated_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('source_dataset', models.ForeignKey(help_text='The dataset this column belongs to.', on_delete=django.db.models.deletion.CASCADE, related_name='source_columns', to='metadata.sourcedataset')),
            ],
            options={
                'verbose_name_plural': 'Source Columns',
                'db_table': 'source_column',
                'ordering': ['source_dataset', 'ordinal_position'],
            },
        ),
        migrations.CreateModel(
            name='SourceDatasetGroup',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True, db_index=True)),
                ('target_short_name', models.CharField(help_text='Short code used to derive the unified target table prefix. eg. sap for grouping sap1 and sap2.', max_length=10, validators=[django.core.validators.RegexValidator(message='Must start with a lowercase letter and contain only lowercase letters and digits. Max length is 10 characters.', regex='^[a-z][a-z0-9]{0,9}$')])),
                ('unified_source_dataset_name', models.CharField(help_text='Unified name of the source object. May be one of the source datasets which participate in this group.', max_length=128)),
                ('description', models.CharField(blank=True, help_text='Optional description why the group was established.', max_length=255, null=True)),
                ('created_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('owner', models.ManyToManyField(blank=True, help_text='Optional governance owner definition. May be used as default owner for generated TargetDatasets.', related_name='source_dataset_groups', to='metadata.person')),
                ('updated_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name_plural': 'Source Dataset Groups',
                'db_table': 'source_dataset_group',
                'ordering': ['target_short_name', 'unified_source_dataset_name'],
            },
        ),
        migrations.CreateModel(
            name='SourceDatasetGroupMembership',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True, db_index=True)),
                ('is_primary_system', models.BooleanField(default=False, help_text="If checked, this dataset is considered the 'golden' / leading source for this group.")),
                ('source_identity_id', models.CharField(blank=True, help_text="Optional identifier used to distinguish rows when multiple source datasets are grouped (e.g. 'aw1', 'aw2'). If set, it can be used as additional business key component or as tie-breaker in incremental logic.", max_length=30, null=True)),
                ('source_identity_ordinal', models.PositiveIntegerField(blank=True, help_text='Optional priority score for this source within the group. Lower values mean higher priority. If not set, the default order uses is_primary_system and identity id.', null=True)),
                ('created_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('group', models.ForeignKey(help_text='The source dataset group. Only necessary to store if more than one source datasets should be grouped together.', on_delete=django.db.models.deletion.CASCADE, related_name='memberships', to='metadata.sourcedatasetgroup')),
                ('source_dataset', models.ForeignKey(help_text='The dataset to be assigned to the group.', on_delete=django.db.models.deletion.CASCADE, related_name='dataset_groups', to='metadata.sourcedataset')),
                ('updated_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'db_table': 'source_dataset_group_membership',
                'ordering': ['-is_primary_system', 'group', 'source_dataset'],
            },
        ),
        migrations.CreateModel(
            name='SourceDatasetIncrementPolicy',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True, db_index=True)),
                ('environment', models.CharField(choices=[('dev', 'Development'), ('test', 'Test'), ('prod', 'Production')], help_text='Environment this policy applies to (e.g. dev, test, prod).', max_length=20)),
                ('increment_interval_length', models.PositiveIntegerField(help_text="How far to look back from 'now' for incremental loads in this environment.")),
                ('increment_interval_unit', models.CharField(choices=[('day', 'Day'), ('month', 'Month'), ('year', 'Year')], help_text='Unit for the increment interval length.', max_length=10)),
                ('active', models.BooleanField(default=True, help_text='If multiple rows exist (history), which one is currently active.')),
                ('created_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('source_dataset', models.ForeignKey(help_text='The dataset this policy applies to.', on_delete=django.db.models.deletion.CASCADE, related_name='increment_policies', to='metadata.sourcedataset')),
                ('updated_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'db_table': 'source_dataset_increment_policy',
                'ordering': ['source_dataset', 'environment'],
            },
        ),
        migrations.CreateModel(
            name='SourceDatasetOwnership',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True, db_index=True)),
                ('role', models.CharField(choices=[('business', 'Business Owner'), ('steward', 'Data Steward'), ('technical', 'Technical Owner')], help_text='The role which the person has on the dataset.', max_length=20)),
                ('is_primary_owner', models.BooleanField(default=False, help_text='If checked, this is the primary ownership.')),
                ('since', models.DateField(blank=True, help_text='The date from which the ownership will start.', null=True)),
                ('until', models.DateField(blank=True, help_text='The date on which the ownership will end.', null=True)),
                ('remark', models.CharField(blank=True, help_text='Optional remarks concerning the ownership.', max_length=255, null=True)),
                ('created_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('person', models.ForeignKey(help_text='The person who is declared as owner of the dataset.', on_delete=django.db.models.deletion.PROTECT, related_name='source_dataset_ownerships', to='metadata.person')),
                ('source_dataset', models.ForeignKey(help_text='The dataset for which an owner is declared.', on_delete=django.db.models.deletion.CASCADE, related_name='source_dataset_ownerships', to='metadata.sourcedataset')),
                ('updated_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'ordering': ['-is_primary_owner', 'source_dataset', 'role', 'since'],
            },
        ),
        migrations.AddField(
            model_name='sourcedataset',
            name='owner',
            field=models.ManyToManyField(blank=True, help_text='Declared business / technical owners with roles.', related_name='source_datasets', through='metadata.SourceDatasetOwnership', to='metadata.person'),
        ),
        migrations.CreateModel(
            name='System',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True, db_index=True)),
                ('short_name', models.CharField(help_text="Physical / concrete system identifier. eg. 'sap', 'nav', 'crm', 'ga4', 'dwhdev', 'dwh'.", max_length=10, unique=True, validators=[django.core.validators.RegexValidator(message='Must start with a lowercase letter and contain only lowercase letters and digits. Max length is 10 characters.', regex='^[a-z][a-z0-9]{0,9}$')])),
                ('name', models.CharField(help_text='Identifying name of the system. Does not have technical consequences.', max_length=50)),
                ('description', models.CharField(blank=True, help_text='Business description / semantic meaning of the system.', max_length=255, null=True)),
                ('type', models.CharField(choices=[('redshift', 'Amazon Redshift'), ('s3', 'Amazon S3 Storage (manual, no reflection)'), ('azureblob', 'Azure Blob Storage (manual, no reflection)'), ('csv', 'CSV File(s) (manual, no reflection)'), ('clickhouse', 'ClickHouse (beta, limited reflection)'), ('databricks', 'Databricks SQL'), ('duckdb', 'DuckDB'), ('exasol', 'Exasol (manual, no reflection)'), ('excel', 'Excel / XLSX File(s) (manual, no reflection)'), ('bigquery', 'Google BigQuery'), ('gcs', 'Google Cloud Storage (manual, no reflection)'), ('graphql', 'GraphQL API (manual, no reflection)'), ('db2', 'IBM DB2 (manual, no reflection)'), ('json', 'JSON File(s) (manual, no reflection)'), ('jsonl', 'JSON Lines File(s) (manual, no reflection)'), ('mysql', 'MySQL / MariaDB'), ('oracle', 'Oracle'), ('parquet', 'Parquet File(s) (manual, no reflection)'), ('postgres', 'PostgreSQL'), ('presto', 'Presto (beta, limited reflection)'), ('rest', 'REST API (manual, no reflection)'), ('hana', 'SAP HANA (manual, no reflection)'), ('sapr3', 'SAP R/3 (manual, no reflection)'), ('sftp', 'SFTP Location (manual, no reflection)'), ('mssql', 'SQL Server'), ('sqlite', 'SQLite'), ('snowflake', 'Snowflake'), ('teradata', 'Teradata (manual, no reflection)'), ('trino', 'Trino (beta, limited reflection)')], help_text='System type / backend technology. Used for import and adapter logic.', max_length=20)),
                ('target_short_name', models.CharField(help_text="Stable business prefix for stage/rawcore naming (e.g. 'sap', 'crm', 'fi'). Primarily relevant for source-driven layers.", max_length=10, validators=[django.core.validators.RegexValidator(message='Must start with a lowercase letter and contain only lowercase letters and digits. Max length is 10 characters.', regex='^[a-z][a-z0-9]{0,9}$')])),
                ('is_source', models.BooleanField(default=True, help_text='If checked, this system acts as a source (has datasets, ingestion, etc.).')),
                ('is_target', models.BooleanField(default=False, help_text='If checked, this system acts as a target platform (warehouse/lakehouse/etc.).')),
                ('include_ingest', models.CharField(choices=[('none', 'None'), ('external', 'External'), ('native', 'Native')], default='none', help_text='How/if this system participates in ingestion pipelines. Only relevant if is_source=True.', max_length=20)),
                ('generate_raw_tables', models.BooleanField(default=False, help_text="Default policy: create raw landing tables (TargetDatasets in schema 'raw') for all SourceDatasets in this system. Only relevant if is_source=True.")),
                ('active', models.BooleanField(default=True, help_text='System is still considered a live data source / target.')),
                ('retired_at', models.DateTimeField(blank=True, help_text='Automatically set when active is unchecked.', null=True)),
                ('created_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('updated_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name_plural': 'Systems',
                'db_table': 'system',
                'ordering': ['short_name'],
            },
        ),
        migrations.AddField(
            model_name='sourcedataset',
            name='source_system',
            field=models.ForeignKey(help_text='The system this dataset comes from (must have is_source=True).', limit_choices_to={'is_source': True}, on_delete=django.db.models.deletion.CASCADE, related_name='source_datasets', to='metadata.system'),
        ),
        migrations.CreateModel(
            name='TargetColumn',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True, db_index=True)),
                ('target_column_name', models.CharField(help_text="Final column name in snake_case. eg. 'customer_name', 'order_created_tms'.", max_length=63)),
                ('ordinal_position', models.PositiveIntegerField(help_text='Column order within the dataset.')),
                ('datatype', models.CharField(choices=[('BIGINT', 'Big Integer'), ('BINARY', 'Binary'), ('BOOLEAN', 'Boolean'), ('DATE', 'Date'), ('DECIMAL', 'Decimal'), ('FLOAT', 'Float'), ('INTEGER', 'Integer'), ('JSON', 'JSON'), ('STRING', 'String'), ('TIME', 'Time'), ('TIMESTAMP', 'Timestamp'), ('UUID', 'UUID')], help_text='Logical / normalized datatype.', max_length=20)),
                ('max_length', models.PositiveIntegerField(blank=True, help_text='How many characters the field may have.', null=True)),
                ('decimal_precision', models.PositiveIntegerField(blank=True, help_text='If datatype decimal The decimal precision of the column.', null=True)),
                ('decimal_scale', models.PositiveIntegerField(blank=True, help_text='If datatype decimal, the number of decimal places of the column.', null=True)),
                ('nullable', models.BooleanField(default=True, help_text='Whether this column can be NULL in the final target dataset.')),
                ('system_role', models.CharField(blank=True, choices=[('', 'â€”'), ('business_key', 'Business key'), ('surrogate_key', 'Surrogate key'), ('foreign_key', 'Foreign key'), ('entity_key', 'Entity key'), ('row_hash', 'Row hash'), ('load_run_id', 'Load run id'), ('loaded_at', 'Loaded at timestamp'), ('version_started_at', 'Version started at'), ('version_ended_at', 'Version ended at'), ('version_state', 'Version state')], default='', help_text='Semantic role for system-managed columns. Used to reliably render/execute technical columns (e.g. load_run_id, loaded_at) and to support forensics without relying on naming conventions.', max_length=30)),
                ('manual_expression', models.TextField(blank=True, help_text='Optional expression for deriving this column.\n- If you use elevata DSL, wrap it in {{ ... }}, e.g. {{ UPPER(customer_name) }}.\n- If you enter plain SQL without {{ }}, it is treated as target-specific SQL and used directly in generated SQL / SQL preview.\nThis default applies to all inputs unless overridden at source level.', null=True)),
                ('description', models.CharField(blank=True, help_text='Business description / semantic meaning of the column.', max_length=255, null=True)),
                ('pii_level', models.CharField(choices=[('none', 'No personal data'), ('personal_data', 'Personal data'), ('special_category_data', 'Special category personal data')], default='none', help_text='PII classification of this column, if applicable.', max_length=30)),
                ('remark', models.CharField(blank=True, help_text='Free-form notes.', max_length=255, null=True)),
                ('sensitivity', models.CharField(choices=[('public', 'Public'), ('internal', 'Internal'), ('confidential', 'Confidential'), ('highly_confidential', 'Highly Confidential')], default='public', help_text='Sensitivity classification for this column (e.g. public, confidential, restricted).', max_length=30)),
                ('lineage_origin', models.CharField(choices=[('direct', 'Direct'), ('derived', 'Derived'), ('lookup_join', 'Lookup Join'), ('constant', 'Constant'), ('surrogate_key', 'Surrogate Key'), ('foreign_key', 'Foreign Key')], default='direct', help_text='How this column is derived: direct source field, derived calculation, lookup join, constant, etc.', max_length=20)),
                ('surrogate_expression', models.TextField(blank=True, help_text='Platform-neutral expression used to generate the surrogate key (e.g. hash256).', null=True)),
                ('profiling_stats', models.JSONField(blank=True, help_text='Optional summarized profiling statistics for this column, stored as JSON. Use valid JSON syntax (key-value pairs). Example: {"null_rate": 0.02, "distinct_count": 123, "top_values": ["A", "B", "C"]}', null=True)),
                ('active', models.BooleanField(default=True, help_text='If unchecked, this column is deprecated. It remains in metadata for lineage and documentation but should not be generated, deployed, or used for new models.')),
                ('retired_at', models.DateTimeField(blank=True, help_text='Optional timestamp when this column was marked as inactive. Automatically set when active is unchecked.', null=True)),
                ('lineage_key', models.CharField(blank=True, db_index=True, help_text='Stable technical key used by the generator to identify this column by its source lineage instead of its physical name. Ensures that renaming target_column_name does not create duplicates.', max_length=255, null=True)),
                ('former_names', models.JSONField(blank=True, default=list, help_text='List of previous physical column names for this TargetColumn. Used by materialization sync to detect renames and emit RENAME COLUMN instead of ADD COLUMN. Technical governance field; do not edit manually.')),
                ('is_system_managed', models.BooleanField(default=False, help_text='If checked, this column is managed by the system and core attributes are locked.')),
                ('created_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('updated_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name_plural': 'Target Columns',
                'db_table': 'target_column',
                'ordering': ['target_dataset', 'ordinal_position'],
            },
        ),
        migrations.CreateModel(
            name='TargetColumnInput',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True, db_index=True)),
                ('manual_expression', models.TextField(blank=True, help_text='Optional expression that applies ONLY when using this specific source column.\n- Prefer elevata DSL wrapped in {{ ... }} for generation.\n- If you enter plain SQL without {{ }}, it may be used directly in SQL preview for this input.\nIf empty, the TargetColumn.manual_expression (or a direct column reference) is used.', null=True)),
                ('ordinal_position', models.PositiveIntegerField(default=1, help_text='Priority / fallback order when multiple source systems feed the same target column. 1 = highest priority.')),
                ('active', models.BooleanField(default=True, help_text='If unchecked, kept for lineage/history but ignored going forward.')),
                ('created_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('source_column', models.ForeignKey(blank=True, help_text='The original source column feeding this target column.', null=True, on_delete=django.db.models.deletion.PROTECT, related_name='output_links', to='metadata.sourcecolumn')),
                ('target_column', models.ForeignKey(help_text='The target column being populated.', on_delete=django.db.models.deletion.CASCADE, related_name='input_links', to='metadata.targetcolumn')),
                ('updated_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('upstream_target_column', models.ForeignKey(blank=True, help_text='If set, this target column is fed from another target column instead of a raw source column.', null=True, on_delete=django.db.models.deletion.PROTECT, related_name='downstream_column_inputs', to='metadata.targetcolumn')),
            ],
            options={
                'db_table': 'target_column_input',
                'ordering': ['target_column', 'ordinal_position'],
            },
        ),
        migrations.AddField(
            model_name='targetcolumn',
            name='source_columns',
            field=models.ManyToManyField(blank=True, help_text='Which source columns contribute to this target column.', related_name='mapped_target_columns', through='metadata.TargetColumnInput', through_fields=('target_column', 'source_column'), to='metadata.sourcecolumn'),
        ),
        migrations.AddField(
            model_name='targetcolumn',
            name='upstream_columns',
            field=models.ManyToManyField(blank=True, help_text='Which other target columns feed this target column as upstream instead of source columns.', related_name='downstream_columns', through='metadata.TargetColumnInput', through_fields=('target_column', 'upstream_target_column'), to='metadata.targetcolumn'),
        ),
        migrations.CreateModel(
            name='TargetDataset',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True, db_index=True)),
                ('target_dataset_name', models.CharField(help_text="Final dataset (table/view) name, snake_case inc. layer prefix. eg. 'rc_sap_customer', 'rc_sap_sales_order'.", max_length=63)),
                ('description', models.CharField(blank=True, help_text='Business description / semantic meaning of the dataset.', max_length=255, null=True)),
                ('handle_deletes', models.BooleanField(default=True, help_text='Whether deletes in the source should be reflected in this dataset. Only relevant with incremental or historization tables.')),
                ('historize', models.BooleanField(default=True, help_text='Track slowly changing state / valid_from / valid_to, etc.')),
                ('combination_mode', models.CharField(choices=[('single', 'Single upstream (no combination)'), ('union', 'Union of multiple upstream datasets')], default='single', help_text="How multiple upstream datasets are combined in the pipeline. 'single' = one upstream, 'union' = append all upstreams.", max_length=20)),
                ('biz_entity_role', models.CharField(blank=True, choices=[('core_entity', 'Core entity'), ('fact', 'Fact table'), ('dimension', 'Dimension'), ('reference', 'Reference / master data')], help_text='Semantic role of this dataset in the BizCore model. Examples: core_entity, fact, dimension, reference.', max_length=30, null=True)),
                ('biz_grain_note', models.CharField(blank=True, help_text="Human-readable description of the business grain. Example: 'one row per customer and today', 'one row per contract and day'.", max_length=255, null=True)),
                ('incremental_strategy', models.CharField(choices=[('full', 'Full load (truncate + reload)'), ('append', 'Append-only incremental load'), ('merge', 'Merge (upsert by business key, handle deletes)'), ('snapshot', 'Snapshot-based load')], default='full', help_text='How this dataset is loaded.\n- full: always full refresh (truncate + reload)\n- append: append-only incremental load\n- merge: upsert by business key and handle deletes\n- snapshot: periodic snapshots by watermark/date', max_length=20)),
                ('manual_model', models.BooleanField(default=False, help_text='If checked: dataset is manually maintained, not fully auto-generated.')),
                ('distinct_select', models.BooleanField(default=False, help_text='If checked: SELECT DISTINCT is enforced during generation.')),
                ('static_filter', models.CharField(blank=True, help_text="Optional row-level filter to restrict records. Static WHERE clause applied to all loads of this dataset. Used for permanent business or technical scoping. Example: is_deleted_flag = 0 AND country_code = 'DE'.", max_length=255, null=True)),
                ('materialization_type', models.CharField(blank=True, choices=[('table', 'table'), ('view', 'view'), ('incremental', 'incremental'), ('external_passthrough', 'external_passthrough')], help_text='If set, overrides target_schema.default_materialization_type for this dataset. If null, dataset inherits the schema default.', max_length=30, null=True)),
                ('sensitivity', models.CharField(choices=[('public', 'Public'), ('internal', 'Internal'), ('confidential', 'Confidential'), ('highly_confidential', 'Highly Confidential')], default='public', help_text='Confidentiality / sensitivity level for this dataset.', max_length=30)),
                ('access_intent', models.CharField(blank=True, choices=[('internal_reporting', 'Internal Reporting'), ('analytics', 'Analytics / BI'), ('ml_training', 'Machine Learning / AI'), ('compliance', 'Regulatory / Compliance'), ('exploration', 'Ad-hoc Exploration'), ('integration', 'System Integration')], help_text='Intended usage for governance purposes, e.g. analytics, finance_reporting, ml_feature_store.', max_length=30, null=True)),
                ('active', models.BooleanField(default=True, help_text='If unchecked, this dataset is deprecated. It remains in metadata for lineage and documentation but should not be generated, deployed, or used for new models.')),
                ('retired_at', models.DateTimeField(blank=True, help_text='Optional timestamp when this dataset was marked as inactive. Automatically set when active gets unchecked.', null=True)),
                ('lineage_key', models.CharField(blank=True, db_index=True, help_text='Stable technical key used by the generator to identify this dataset by its source lineage instead of its physical name. Ensures that renaming target_dataset_name does not create duplicates.', max_length=255, null=True)),
                ('former_names', models.JSONField(blank=True, default=list, help_text='List of previous physical dataset names for this TargetDataset. Used by materialization sync to detect renames and emit RENAME TABLE/VIEW instead of creating a new object. Technical governance field; do not edit manually.')),
                ('is_system_managed', models.BooleanField(default=False, help_text='If checked, this dataset is managed by the system and core attributes are locked.')),
                ('created_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('incremental_source', models.ForeignKey(blank=True, help_text="If set, this target dataset inherits incremental window logic (and delete detection scope) from the referenced SourceDataset. The referenced dataset's increment_filter defines which records are considered 'in scope' for delta load & delete detection.", null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='incremental_targets', to='metadata.sourcedataset')),
                ('partial_load', models.ManyToManyField(blank=True, db_table='target_dataset_partial_load', help_text='Optional subset extraction definitions (per environment / window).', related_name='datasets', to='metadata.partialload')),
                ('query_root', models.ForeignKey(blank=True, help_text='Optional query-tree root. If empty, dataset uses the classic select/joins definition.', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to='metadata.querynode')),
                ('query_head', models.ForeignKey(blank=True, help_text='Optional query-tree head (leaf): the final node that represents the dataset output. query_root stays stable (Base select); query_head moves when adding wrapper nodes (aggregate/window/union). If null while query_root is set, treat query_root as head.', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to='metadata.querynode')),
                ('updated_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name_plural': 'Target Datasets',
                'db_table': 'target_dataset',
                'ordering': ['target_schema', 'target_dataset_name'],
            },
        ),
        migrations.AddField(
            model_name='targetcolumn',
            name='target_dataset',
            field=models.ForeignKey(help_text='The dataset this column belongs to.', on_delete=django.db.models.deletion.CASCADE, related_name='target_columns', to='metadata.targetdataset'),
        ),
        migrations.AddField(
            model_name='querynode',
            name='target_dataset',
            field=models.ForeignKey(help_text='Owning dataset (lifecycle/permissions scope).', on_delete=django.db.models.deletion.CASCADE, related_name='query_nodes', to='metadata.targetdataset'),
        ),
        migrations.AddField(
            model_name='partitionbyexpression',
            name='target_dataset',
            field=models.ForeignKey(help_text='Owning dataset (permissions / lifecycle scope).', on_delete=django.db.models.deletion.CASCADE, related_name='partition_by_expressions', to='metadata.targetdataset'),
        ),
        migrations.AddField(
            model_name='orderbyexpression',
            name='target_dataset',
            field=models.ForeignKey(help_text='Owning dataset (permissions / lifecycle scope).', on_delete=django.db.models.deletion.CASCADE, related_name='order_by_expressions', to='metadata.targetdataset'),
        ),
        migrations.CreateModel(
            name='TargetDatasetInput',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True, db_index=True)),
                ('role', models.CharField(choices=[('primary', 'Primary (golden source)'), ('enrichment', 'Enrichment (same entity, more attributes)'), ('reference_lookup', 'Reference Lookup / Code table'), ('audit_only', 'Audit / Technical Metadata only')], help_text='How this source contributes to the target: primary (golden source), enrichment (same entity extra attrs), reference_lookup (dim/code join), or audit_only (technical metadata).', max_length=50)),
                ('active', models.BooleanField(default=True, help_text='If unchecked, this mapping is retained for lineage/audit but is no longer used for load.')),
                ('created_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('source_dataset', models.ForeignKey(blank=True, help_text='The source dataset contributing to this target dataset.', null=True, on_delete=django.db.models.deletion.PROTECT, related_name='output_links', to='metadata.sourcedataset')),
                ('target_dataset', models.ForeignKey(help_text='The stage/rawcore/bizcore dataset being built.', on_delete=django.db.models.deletion.CASCADE, related_name='input_links', to='metadata.targetdataset')),
                ('updated_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('upstream_target_dataset', models.ForeignKey(blank=True, help_text='If set, this target dataset is used as upstream instead of a source dataset.', null=True, on_delete=django.db.models.deletion.PROTECT, related_name='downstream_input_links', to='metadata.targetdataset')),
            ],
            options={
                'db_table': 'target_dataset_input',
            },
        ),
        migrations.AddField(
            model_name='targetdataset',
            name='source_datasets',
            field=models.ManyToManyField(blank=True, help_text='Which source datasets feed this target dataset. Used for multi-source consolidation, staging, rawcore integration, etc.', related_name='target_datasets', through='metadata.TargetDatasetInput', through_fields=('target_dataset', 'source_dataset'), to='metadata.sourcedataset'),
        ),
        migrations.AddField(
            model_name='targetdataset',
            name='upstream_datasets',
            field=models.ManyToManyField(blank=True, help_text='Which other target dataset feed this target dataset as upstream instead of source datasets.', related_name='downstream_datasets', through='metadata.TargetDatasetInput', through_fields=('target_dataset', 'upstream_target_dataset'), to='metadata.targetdataset'),
        ),
        migrations.CreateModel(
            name='TargetDatasetJoin',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True, db_index=True)),
                ('join_type', models.CharField(choices=[('inner', 'INNER'), ('left', 'LEFT'), ('right', 'RIGHT'), ('full', 'FULL'), ('cross', 'CROSS')], default='left', help_text='Join type.\nTypical patterns:\n  - LEFT: keep all rows from the left input and enrich from the right\n  - INNER: only rows that match on the join condition\n  - CROSS: no condition, creates a Cartesian product (date spine etc.)\n\nNote: CROSS JOIN must not have predicates.', max_length=10)),
                ('join_order', models.PositiveIntegerField(default=1, help_text='Deterministic ordering when multiple joins exist. If you join multiple inputs (A join B join C), elevata applies joins in this order.')),
                ('description', models.TextField(blank=True, default='', help_text="Explain the business intent of this join.\nExample: 'Enrich customers with their latest known address.'\nThis text can be shown in details/snapshots for explainability.")),
                ('created_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('left_input', models.ForeignKey(help_text="Left side of the join (primary input). This is typically the 'main entity' input (e.g. person). In generated SQL, this becomes the main FROM source.", on_delete=django.db.models.deletion.CASCADE, related_name='as_left_join', to='metadata.targetdatasetinput')),
                ('right_input', models.ForeignKey(help_text='Right side of the join (enrichment / lookup input). In generated SQL, this becomes the JOINed source.', on_delete=django.db.models.deletion.CASCADE, related_name='as_right_join', to='metadata.targetdatasetinput')),
                ('target_dataset', models.ForeignKey(help_text='The dataset that will be built (Bizcore/Serving). This join defines how multiple upstream inputs are combined.', on_delete=django.db.models.deletion.CASCADE, related_name='joins', to='metadata.targetdataset')),
                ('updated_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'ordering': ['join_order', 'id'],
            },
        ),
        migrations.CreateModel(
            name='TargetDatasetJoinPredicate',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True, db_index=True)),
                ('ordinal_position', models.PositiveIntegerField(default=1, help_text='Predicate ordering. Predicates are combined with AND in this order (MVP).\nExample: 1) id equality, 2) valid_from <= date, 3) date < valid_to.')),
                ('left_expr', models.TextField(help_text="Left-side expression.\nYou can enter:\n  - a column name (recommended): address_id\n  - a constant: 'DE'\n  - a simple expression: lower(country_code)\n  - DSL block: {{ coalesce(country_code, 'DE') }}\n\nTip: Usually you do NOT need to add table aliases. elevata can qualify references based on your configured upstream inputs.")),
                ('operator', models.CharField(choices=[('=', '='), ('!=', '!='), ('<', '<'), ('<=', '<='), ('>', '>'), ('>=', '>='), ('LIKE', 'LIKE'), ('IN', 'IN'), ('BETWEEN', 'BETWEEN'), ('IS NULL', 'IS NULL'), ('IS NOT NULL', 'IS NOT NULL')], default='=', help_text="Comparison operator.\nRules:\n  - BETWEEN uses right_expr (lower) + right_expr_2 (upper)\n  - IS NULL / IS NOT NULL do not use right_expr\n  - All other operators use right_expr\n\nExamples:\n  - customer_id = person_id\n  - country_code = 'DE'\n  - valid_from <= d.date\n  - d.date BETWEEN valid_from AND valid_to", max_length=20)),
                ('right_expr', models.TextField(blank=True, help_text="Right-side expression (required for most operators).\nExamples:\n  - a column name: person_id\n  - a constant: 'DE', 1\n  - a function call: date_trunc('day', ts)\n  - DSL block: {{ date_trunc('day', ts) }}\n", null=True)),
                ('right_expr_2', models.TextField(blank=True, help_text='Second right-side expression (only for BETWEEN).\nExample:\n  d.date BETWEEN valid_from AND valid_to', null=True)),
                ('created_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('join', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='predicates', to='metadata.targetdatasetjoin')),
                ('updated_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'ordering': ['ordinal_position', 'id'],
            },
        ),
        migrations.CreateModel(
            name='TargetDatasetOwnership',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True, db_index=True)),
                ('role', models.CharField(choices=[('business', 'Business Owner'), ('steward', 'Data Steward'), ('technical', 'Technical Owner')], help_text='The role which the person has on the dataset.', max_length=20)),
                ('is_primary_owner', models.BooleanField(default=False, help_text='If checked, this is the primary ownership.')),
                ('since', models.DateField(blank=True, help_text='The date from which the ownership will start.', null=True)),
                ('until', models.DateField(blank=True, help_text='The date on which the ownership will end.', null=True)),
                ('remark', models.CharField(blank=True, help_text='Optional remarks concerning the ownership.', max_length=255, null=True)),
                ('created_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('person', models.ForeignKey(help_text='The person who has the ownership for the dataset.', on_delete=django.db.models.deletion.PROTECT, related_name='target_dataset_ownerships', to='metadata.person')),
                ('target_dataset', models.ForeignKey(help_text='The dataset for which an owner is declared.', on_delete=django.db.models.deletion.CASCADE, related_name='target_dataset_ownerships', to='metadata.targetdataset')),
                ('updated_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'ordering': ['-is_primary_owner', 'target_dataset', 'role', 'since'],
            },
        ),
        migrations.AddField(
            model_name='targetdataset',
            name='owner',
            field=models.ManyToManyField(blank=True, help_text='Declared business / technical owners with roles.', related_name='target_datasets', through='metadata.TargetDatasetOwnership', to='metadata.person'),
        ),
        migrations.CreateModel(
            name='TargetDatasetReference',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True, db_index=True)),
                ('reference_prefix', models.CharField(blank=True, help_text="If provided, forms the FK name in the child as <prefix>_<referenced_dataset>_key. Example: prefix 'billing' + referenced 'sap_customer' -> 'billing_sap_customer_key'.", max_length=10, null=True, validators=[django.core.validators.RegexValidator(message='Must start with a lowercase letter and contain only lowercase letters and digits. Max length is 10 characters.', regex='^[a-z][a-z0-9]{0,9}$')])),
                ('relationship_type', models.CharField(choices=[('n_to_1', 'n to 1'), ('1_to_n', '1 to n'), ('1_to_1', '1 to 1'), ('n_to_m', 'n to m (future)')], default='n_to_1', help_text='Type of relationship of this reference.', max_length=20)),
                ('join_condition_hint', models.CharField(blank=True, help_text="Human/machine-readable join hint for lineage visualization. Example: 'child.billing_sap_customer_key = parent.sap_customer_key'.", max_length=255, null=True)),
                ('created_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('referenced_dataset', models.ForeignKey(help_text='Parent dataset that defines the business entity / surrogate PK.', on_delete=django.db.models.deletion.CASCADE, related_name='incoming_references', to='metadata.targetdataset')),
                ('referencing_dataset', models.ForeignKey(help_text='Child dataset that holds the foreign key.', on_delete=django.db.models.deletion.CASCADE, related_name='outgoing_references', to='metadata.targetdataset')),
                ('updated_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name_plural': 'Target Dataset References',
                'db_table': 'target_dataset_reference',
                'ordering': ['referencing_dataset', 'reference_prefix', 'referenced_dataset'],
            },
        ),
        migrations.CreateModel(
            name='TargetDatasetReferenceComponent',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True, db_index=True)),
                ('ordinal_position', models.PositiveIntegerField(default=1, help_text='Order for composite keys.')),
                ('created_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('from_column', models.ForeignKey(help_text='Column on the referencing (child) dataset.', on_delete=django.db.models.deletion.PROTECT, related_name='fk_components_outgoing', to='metadata.targetcolumn')),
                ('reference', models.ForeignKey(help_text='The parent-child relationship this mapping belongs to.', on_delete=django.db.models.deletion.CASCADE, related_name='key_components', to='metadata.targetdatasetreference')),
                ('to_column', models.ForeignKey(help_text='Column on the referenced (parent) dataset.', on_delete=django.db.models.deletion.PROTECT, related_name='fk_components_incoming', to='metadata.targetcolumn')),
                ('updated_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name_plural': 'Target Reference Components',
                'db_table': 'target_reference_key_component',
                'ordering': ['reference', 'ordinal_position'],
            },
        ),
        migrations.CreateModel(
            name='TargetSchema',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True, db_index=True)),
                ('short_name', models.CharField(help_text="Logical layer identifier. Examples: 'raw', 'stage', 'rawcore', 'bizcore', 'serving'. Defines architectural intent and default behavior.", max_length=10, unique=True, validators=[django.core.validators.RegexValidator(message='Must start with a lowercase letter and contain only lowercase letters and digits. Max length is 10 characters.', regex='^[a-z][a-z0-9]{0,9}$')])),
                ('display_name', models.CharField(help_text="Human-readable name, e.g. 'Business Core', 'Serving Layer'.", max_length=50)),
                ('description', models.CharField(blank=True, help_text='Purpose of this layer and what transformations are allowed here.', max_length=255, null=True)),
                ('database_name', models.CharField(help_text='Physical target database / catalog on the destination platform.', max_length=100, validators=[django.core.validators.RegexValidator(message='Must start with a lowercase letter and contain only lowercase letters, digits, and underscores. Max length is 63 characters.', regex='^[a-z][a-z0-9_]{0,62}$')])),
                ('schema_name', models.CharField(help_text='Physical schema / namespace on the destination platform. Defaults to short_name, but can differ if platform naming conventions require it.', max_length=10, validators=[django.core.validators.RegexValidator(message='Must start with a lowercase letter and contain only lowercase letters and digits. Max length is 10 characters.', regex='^[a-z][a-z0-9]{0,9}$')])),
                ('physical_prefix', models.CharField(blank=True, help_text="Optional physical naming prefix for datasets in this schema, eg. 'raw', 'stg', 'rc'. Will be prepended like '<prefix>_<sys>_<obj>'. If empty, no prefix will be added.", max_length=10, null=True, validators=[django.core.validators.RegexValidator(message='Must start with a lowercase letter and contain only lowercase letters and digits. Max length is 10 characters.', regex='^[a-z][a-z0-9]{0,9}$')])),
                ('generate_layer', models.BooleanField(default=True, help_text='If checked, datasets for this layer are generated automatically from source metadata (e.g. raw, stage, rawcore). Uncheck for curated layers (e.g. bizcore, serving).')),
                ('is_user_visible', models.BooleanField(default=True, help_text='Whether end users can actively model new datasets in this layer. If unchecked, this layer is internal/technical and hidden in normal UIs.')),
                ('default_materialization_type', models.CharField(choices=[('table', 'table'), ('view', 'view'), ('incremental', 'incremental'), ('external_passthrough', 'external_passthrough')], default='table', help_text='Default materialization strategy for datasets in this layer.', max_length=30)),
                ('default_historize', models.BooleanField(default=True, help_text='Whether datasets in this layer are expected to track history / SCD-style state.')),
                ('incremental_strategy_default', models.CharField(choices=[('full', 'Full load (truncate + reload)'), ('append', 'Append-only incremental load'), ('merge', 'Merge (upsert by business key, handle deletes)'), ('snapshot', 'Snapshot-based load')], default='full', help_text='Default incremental loading strategy for datasets in this schema when the source is incremental. For non-incremental sources, a full refresh is always used.', max_length=20)),
                ('sensitivity_default', models.CharField(choices=[('public', 'Public'), ('internal', 'Internal'), ('confidential', 'Confidential'), ('highly_confidential', 'Highly Confidential')], default='public', help_text='Default sensitivity classification for datasets in this schema (e.g. public, confidential).', max_length=30)),
                ('access_intent_default', models.CharField(blank=True, choices=[('internal_reporting', 'Internal Reporting'), ('analytics', 'Analytics / BI'), ('ml_training', 'Machine Learning / AI'), ('compliance', 'Regulatory / Compliance'), ('exploration', 'Ad-hoc Exploration'), ('integration', 'System Integration')], help_text='Default usage intent for governance purposes: analytics, finance_reporting, operations, ml_feature_store, etc.', max_length=30, null=True)),
                ('surrogate_keys_enabled', models.BooleanField(default=True, help_text='If checked, this layer is expected to generate deterministic surrogate keys for its primary entities. If unchecked, no surrogate keys will be generated.')),
                ('surrogate_key_algorithm', models.CharField(default='sha256', help_text='Hash algorithm used for deterministic surrogate keys in this layer.', max_length=20)),
                ('surrogate_key_null_token', models.CharField(default='null_replaced', help_text='Token to use instead of NULL in natural key components.', max_length=50)),
                ('surrogate_key_pair_separator', models.CharField(default='~', help_text='Separator between field name and value within one component.', max_length=5)),
                ('surrogate_key_component_separator', models.CharField(default='|', help_text='Separator between components in the natural key string.', max_length=5)),
                ('pepper_strategy', models.CharField(default='runtime_pepper', help_text='How pepper is injected at runtime. No pepper value is stored in metadata.', max_length=50)),
                ('is_system_managed', models.BooleanField(default=False, help_text='If checked, this schema is managed by the system and core attributes are locked.')),
                ('created_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('updated_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name_plural': 'Target Schemas',
                'db_table': 'target_schema',
                'ordering': ['short_name'],
            },
        ),
        migrations.AddField(
            model_name='targetdataset',
            name='target_schema',
            field=models.ForeignKey(help_text='Which layer / schema this dataset belongs to. Defines physical DB/schema, default materialization and governance expectations.', on_delete=django.db.models.deletion.PROTECT, related_name='target_datasets', to='metadata.targetschema'),
        ),
        migrations.CreateModel(
            name='Team',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True, db_index=True)),
                ('name', models.CharField(help_text='Name of the team, eg. Sales, Finance, ...', max_length=30, unique=True)),
                ('description', models.CharField(blank=True, help_text='Optional description of the team.', max_length=255, null=True)),
                ('created_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('updated_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name_plural': 'Teams',
                'db_table': 'team',
                'ordering': ['name'],
            },
        ),
        migrations.AddField(
            model_name='person',
            name='team',
            field=models.ManyToManyField(blank=True, db_table='team_person', help_text='The team(s) the person is assigned to.', related_name='persons', to='metadata.team'),
        ),
        migrations.CreateModel(
            name='OrderByItem',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True, db_index=True)),
                ('input_column_name', models.CharField(help_text='Column name exposed by the input node to order by.', max_length=255)),
                ('direction', models.CharField(choices=[('ASC', 'ASC'), ('DESC', 'DESC')], default='ASC', help_text='Sort direction.', max_length=4)),
                ('nulls_placement', models.CharField(blank=True, choices=[('', 'Dialect default'), ('FIRST', 'NULLS FIRST'), ('LAST', 'NULLS LAST')], default='', help_text='NULLS placement if supported by dialect.', max_length=5)),
                ('ordinal_position', models.PositiveIntegerField(default=0, help_text='Position of this item inside the ORDER BY list (0..n).')),
                ('created_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('order_by', models.ForeignKey(help_text='ORDER BY definition this item belongs to.', on_delete=django.db.models.deletion.CASCADE, related_name='items', to='metadata.orderbyexpression')),
                ('updated_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'db_table': 'order_by_item',
                'unique_together': {('order_by', 'ordinal_position')},
            },
        ),
        migrations.CreateModel(
            name='PartitionByItem',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True, db_index=True)),
                ('input_column_name', models.CharField(help_text='Column name exposed by the input node to partition by.', max_length=255)),
                ('ordinal_position', models.PositiveIntegerField(default=0, help_text='Position of this partition key within the PARTITION BY clause.')),
                ('created_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('partition_by', models.ForeignKey(help_text='PARTITION BY definition this item belongs to.', on_delete=django.db.models.deletion.CASCADE, related_name='items', to='metadata.partitionbyexpression')),
                ('updated_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'db_table': 'partition_by_item',
                'unique_together': {('partition_by', 'ordinal_position')},
            },
        ),
        migrations.CreateModel(
            name='QueryAggregateMeasure',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True, db_index=True)),
                ('output_name', models.CharField(help_text='Output column name (can be friendly in serving).', max_length=255)),
                ('function', models.CharField(choices=[('SUM', 'SUM'), ('COUNT', 'COUNT'), ('MIN', 'MIN'), ('MAX', 'MAX'), ('AVG', 'AVG')], help_text='Aggregate function.', max_length=32)),
                ('input_column_name', models.CharField(blank=True, default='', help_text='Input column used as argument (empty for COUNT(*)).', max_length=255)),
                ('delimiter', models.CharField(blank=True, default=',', help_text='Delimiter used by STRING_AGG (ignored for other aggregate functions).', max_length=64)),
                ('distinct', models.BooleanField(default=False, help_text='If true, applies DISTINCT on the argument when supported (e.g., COUNT(DISTINCT x)).')),
                ('ordinal_position', models.PositiveIntegerField(default=0, help_text='Ordering of measures in UI and generated SQL.')),
                ('created_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('order_by', models.ForeignKey(blank=True, help_text='Optional ORDER BY expression used inside the aggregate function (e.g., STRING_AGG).', null=True, on_delete=django.db.models.deletion.PROTECT, to='metadata.orderbyexpression')),
                ('updated_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('aggregate_node', models.ForeignKey(help_text='Aggregate operator this measure belongs to.', on_delete=django.db.models.deletion.CASCADE, related_name='measures', to='metadata.queryaggregatenode')),
            ],
            options={
                'db_table': 'query_aggregate_measure',
                'unique_together': {('aggregate_node', 'ordinal_position')},
            },
        ),
        migrations.CreateModel(
            name='QueryAggregateGroupKey',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True, db_index=True)),
                ('input_column_name', models.CharField(help_text='Column name exposed by input node to group by.', max_length=255)),
                ('output_name', models.CharField(blank=True, default='', help_text='Optional alias in the aggregate output (defaults to input_column_name).', max_length=255)),
                ('ordinal_position', models.PositiveIntegerField(default=0, help_text='Ordering of group keys in UI and generated SQL.')),
                ('created_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('updated_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('aggregate_node', models.ForeignKey(help_text='Aggregate operator this group key belongs to.', on_delete=django.db.models.deletion.CASCADE, related_name='group_keys', to='metadata.queryaggregatenode')),
            ],
            options={
                'db_table': 'query_aggregate_node_group_key',
                'unique_together': {('aggregate_node', 'ordinal_position')},
            },
        ),
        migrations.CreateModel(
            name='QueryUnionBranchMapping',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True, db_index=True)),
                ('input_column_name', models.CharField(help_text='Column name exposed by branch input node.', max_length=255)),
                ('branch', models.ForeignKey(help_text='Branch this mapping belongs to.', on_delete=django.db.models.deletion.CASCADE, related_name='mappings', to='metadata.queryunionbranch')),
                ('created_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('updated_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('output_column', models.ForeignKey(help_text='Output column of the UNION schema contract that is being populated.', on_delete=django.db.models.deletion.CASCADE, related_name='branch_mappings', to='metadata.queryunionoutputcolumn')),
            ],
            options={
                'db_table': 'query_union_branch_mapping',
                'unique_together': {('branch', 'output_column')},
            },
        ),
        migrations.CreateModel(
            name='QueryWindowColumnArg',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True, db_index=True)),
                ('arg_type', models.CharField(choices=[('column', 'Column'), ('int', 'Integer literal'), ('str', 'String literal')], help_text='Argument type.', max_length=8)),
                ('column_name', models.CharField(blank=True, default='', help_text="Input column name (required when arg_type='column').", max_length=255)),
                ('int_value', models.IntegerField(blank=True, help_text="Integer literal (required when arg_type='int').", null=True)),
                ('str_value', models.CharField(blank=True, default='', help_text="String literal (required when arg_type='str').", max_length=255)),
                ('ordinal_position', models.PositiveIntegerField(default=0, help_text='Position of this argument in the function call.')),
                ('created_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('updated_by', models.ForeignKey(blank=True, editable=False, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('window_column', models.ForeignKey(help_text='Window column this argument belongs to.', on_delete=django.db.models.deletion.CASCADE, related_name='args', to='metadata.querywindowcolumn')),
            ],
            options={
                'db_table': 'query_window_column_arg',
                'unique_together': {('window_column', 'ordinal_position')},
            },
        ),
        migrations.AddConstraint(
            model_name='sourcecolumn',
            constraint=models.UniqueConstraint(fields=('source_dataset', 'source_column_name'), name='unique_source_column'),
        ),
        migrations.AddConstraint(
            model_name='sourcecolumn',
            constraint=models.UniqueConstraint(fields=('source_dataset', 'ordinal_position'), name='unique_source_column_position'),
        ),
        migrations.AddConstraint(
            model_name='sourcedatasetgroupmembership',
            constraint=models.UniqueConstraint(fields=('group', 'source_dataset'), name='unique_group_membership'),
        ),
        migrations.AddConstraint(
            model_name='sourcedatasetincrementpolicy',
            constraint=models.UniqueConstraint(fields=('source_dataset', 'environment', 'active'), name='unique_active_increment_policy_per_env'),
        ),
        migrations.AddConstraint(
            model_name='sourcedatasetownership',
            constraint=models.UniqueConstraint(fields=('source_dataset', 'person', 'role'), name='unique_source_dataset_ownership'),
        ),
        migrations.AddConstraint(
            model_name='sourcedataset',
            constraint=models.UniqueConstraint(fields=('source_system', 'schema_name', 'source_dataset_name'), name='unique_source_dataset'),
        ),
        migrations.AddConstraint(
            model_name='targetcolumninput',
            constraint=models.UniqueConstraint(fields=('target_column', 'source_column', 'upstream_target_column'), name='unique_target_column_input_source'),
        ),
        migrations.AddConstraint(
            model_name='targetcolumninput',
            constraint=models.CheckConstraint(condition=models.Q(models.Q(('source_column__isnull', False), ('upstream_target_column__isnull', True)), models.Q(('source_column__isnull', True), ('upstream_target_column__isnull', False)), _connector='OR'), name='td_input_exactly_one_column_upstream'),
        ),
        migrations.AddConstraint(
            model_name='targetcolumn',
            constraint=models.UniqueConstraint(fields=('target_dataset', 'target_column_name'), name='unique_target_column'),
        ),
        migrations.AddConstraint(
            model_name='targetcolumn',
            constraint=models.UniqueConstraint(fields=('target_dataset', 'ordinal_position'), name='unique_target_column_position'),
        ),
        migrations.AddIndex(
            model_name='querynode',
            index=models.Index(fields=['target_dataset', 'node_type'], name='query_node_target__dfab21_idx'),
        ),
        migrations.AddIndex(
            model_name='partitionbyexpression',
            index=models.Index(fields=['target_dataset', 'active'], name='partition_b_target__9447b4_idx'),
        ),
        migrations.AlterUniqueTogether(
            name='partitionbyexpression',
            unique_together={('target_dataset', 'name')},
        ),
        migrations.AddIndex(
            model_name='orderbyexpression',
            index=models.Index(fields=['target_dataset', 'active'], name='order_by_ex_target__6813be_idx'),
        ),
        migrations.AlterUniqueTogether(
            name='orderbyexpression',
            unique_together={('target_dataset', 'name')},
        ),
        migrations.AddConstraint(
            model_name='targetdatasetinput',
            constraint=models.UniqueConstraint(fields=('target_dataset', 'source_dataset', 'upstream_target_dataset'), name='unique_source_per_target_dataset'),
        ),
        migrations.AddConstraint(
            model_name='targetdatasetinput',
            constraint=models.CheckConstraint(condition=models.Q(models.Q(('source_dataset__isnull', False), ('upstream_target_dataset__isnull', True)), models.Q(('source_dataset__isnull', True), ('upstream_target_dataset__isnull', False)), _connector='OR'), name='td_input_exactly_one_upstream'),
        ),
        migrations.AddConstraint(
            model_name='targetdatasetjoin',
            constraint=models.UniqueConstraint(fields=('target_dataset', 'join_order'), name='uniq_targetdataset_join_order'),
        ),
        migrations.AddConstraint(
            model_name='targetdatasetjoin',
            constraint=models.UniqueConstraint(fields=('target_dataset', 'left_input', 'right_input'), name='uniq_targetdataset_join_edge'),
        ),
        migrations.AddConstraint(
            model_name='targetdatasetjoinpredicate',
            constraint=models.UniqueConstraint(fields=('join', 'ordinal_position'), name='uniq_join_predicate_order'),
        ),
        migrations.AddConstraint(
            model_name='targetdatasetownership',
            constraint=models.UniqueConstraint(fields=('target_dataset', 'person', 'role'), name='unique_target_dataset_ownership'),
        ),
        migrations.AddConstraint(
            model_name='targetdatasetreference',
            constraint=models.UniqueConstraint(fields=('referencing_dataset', 'reference_prefix', 'referenced_dataset'), name='unique_target_dataset_reference'),
        ),
        migrations.AddConstraint(
            model_name='targetdatasetreferencecomponent',
            constraint=models.UniqueConstraint(fields=('reference', 'from_column', 'to_column'), name='unique_reference_parent_key_component'),
        ),
        migrations.AddConstraint(
            model_name='targetdataset',
            constraint=models.UniqueConstraint(fields=('target_schema', 'target_dataset_name'), name='unique_target_dataset_per_schema'),
        ),
    ]
