<!--
elevata - Metadata-driven Data Platform Framework
Copyright © 2025-2026 Ilona Tag

This file is part of elevata.

elevata is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as
published by the Free Software Foundation, either version 3 of
the License, or (at your option) any later version.

elevata is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with elevata. If not, see <https://www.gnu.org/licenses/>.

Contact: <https://github.com/elevata-labs/elevata>.
-->

{% if show_hr|default:True %}<hr>{% endif %}

<div class="mt-3 d-flex flex-wrap align-items-center gap-3">
  <!-- Dialect selector -->
  <div class="d-flex align-items-center">
    <label for="sql-dialect-select" class="me-2 mb-0 small">
      SQL dialect:
    </label>
    <select
      id="sql-dialect-select"
      name="dialect"
      class="form-select form-select-sm"
      style="width:auto; min-width: 140px;"
      hx-get="{% url 'targetdataset_sql_preview' object.id %}"
      hx-target="#sql-preview"
      hx-swap="innerHTML"
      hx-include="#sql-dialect-select"
      hx-trigger="change"
    >
      {% for name in SQL_DIALECT_CHOICES %}
        <option value="{{ name }}"
          {% if name == SQL_DIALECT_ACTIVE %}selected{% endif %}
        >
          {{ name|upper }}
        </option>
      {% endfor %}
    </select>
  </div>

  <!-- Full SQL -->
  <button
    type="button"
    class="btn btn-primary btn-sm"
    hx-get="{% url 'targetdataset_sql_preview' object.id %}"
    hx-target="#sql-preview"
    hx-swap="innerHTML"
    hx-include="#sql-dialect-select"
    hx-on::before-request="this.setAttribute('disabled','disabled')"
    hx-on::after-request="this.removeAttribute('disabled')"
    hx-indicator="#loading-sql-{{ object.id }}"
  >
    <i class="bi bi-infinity"></i>
    Full SQL
  </button>

  <!-- Incremental MERGE -->
  <button
    type="button"
    class="btn btn-primary btn-sm"
    {% if not object.is_incremental or object.incremental_strategy != 'merge' %}disabled{% endif %}
    hx-get="{% url 'targetdataset_merge_sql_preview' object.id %}"
    hx-target="#sql-preview"
    hx-swap="innerHTML"
    hx-include="#sql-dialect-select"
    hx-on::before-request="this.setAttribute('disabled','disabled')"
    hx-on::after-request="this.removeAttribute('disabled')"
    hx-indicator="#loading-sql-{{ object.id }}"
  >
    <i class="bi bi-diagram-3"></i>
    Incremental MERGE
  </button>

  <!-- Delete detection -->
  <button
    type="button"
    class="btn btn-primary btn-sm"
    {% if not object.is_incremental or not object.handle_deletes %}disabled{% endif %}
    hx-get="{% url 'targetdataset_delete_sql_preview' object.id %}"
    hx-target="#sql-preview"
    hx-swap="innerHTML"
    hx-include="#sql-dialect-select"
    hx-on::before-request="this.setAttribute('disabled','disabled')"
    hx-on::after-request="this.removeAttribute('disabled')"
    hx-indicator="#loading-sql-{{ object.id }}"
  >
    <i class="bi bi-trash3"></i>
    Delete Detection
  </button>

  <!-- Loading indicator -->
  <div id="loading-sql-{{ object.id }}"
      class="htmx-indicator mt-2"
      style="display:none;">
    <div class="spinner-border spinner-border-sm text-info me-2" role="status"></div>
    <span class="text-muted small">Building SQL …</span>
  </div>
</div>

<!-- Container that receives the rendered SQL -->
<div id="sql-preview" class="mt-3"></div>
