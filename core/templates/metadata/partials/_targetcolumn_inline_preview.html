<!--
elevata - Metadata-driven Data Platform Framework
Copyright Â© 2025 Ilona Tag

This file is part of elevata.

elevata is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as
published by the Free Software Foundation, either version 3 of
the License, or (at your option) any later version.

elevata is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with elevata. If not, see <https://www.gnu.org/licenses/>.

Contact: <https://github.com/elevata-labs/elevata>.
-->

<!--
  Purpose:
    - Show validation/impact preview for a TargetColumn rename
    - Provide an 'Apply' button to commit
  Context:
    ok: bool
    errors: list[str]
    impacts: dict (e.g., {models: [...], sql_diff: {...}})
    col: TargetColumn
    new_name: str
-->

{% if ok %}
  <div class="alert alert-success p-2 mb-2">
    {% if impacts.models %}
      <div><strong>Impacted models</strong></div>
      <ul class="mb-2">
        {% for m in impacts.models %}
          <li>{{ m }}</li>
        {% endfor %}
      </ul>
    {% else %}
      <div>No downstream model impacts detected.</div>
    {% endif %}

    <form
      class="mt-2 d-flex gap-2"
      hx-post="{% url 'api_targetcolumn_rename' pk=col.id %}"
      hx-target="#tc-cell-{{ col.id }}"
      hx-swap="outerHTML"
      data-role="tc-rename-apply"
    >
      {% csrf_token %}
      <input type="hidden" name="target_column_name" value="{{ new_name }}" />
      <button type="submit" class="btn btn-primary btn-sm">Apply</button>
      <button
        type="button"
        class="btn btn-outline-secondary btn-sm"
        onclick="
          (function(btn){
            const alertBox = btn.closest('.alert');
            const cell = btn.closest('.tc-cell');
            if (cell) {
              const input = cell.querySelector('input[name=&quot;target_column_name&quot;]');
              if (input) {
                input.value = '{{ col.target_column_name }}';
              }
            }
            if (alertBox) {
              alertBox.remove();
            }
          })(this);
        "
      >
        Cancel
      </button>
    </form>
  </div>
{% else %}
  <div class="alert alert-danger p-2 mb-2">
    <div class="mb-1"><strong>Cannot rename</strong></div>
    <ul class="mb-0">
      {% for e in errors %}
        <li>{{ e }}</li>
      {% endfor %}
    </ul>
  </div>
{% endif %}
