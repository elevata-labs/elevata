<!--
elevata - Metadata-driven Data Platform Framework
Copyright Â© 2025 Ilona Tag

This file is part of elevata.

elevata is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as
published by the Free Software Foundation, either version 3 of
the License, or (at your option) any later version.

elevata is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with elevata. If not, see <https://www.gnu.org/licenses/>.

Contact: <https://github.com/elevata-labs/elevata>.
-->

<!--
  Partial: _targetdataset_inline_cell.html
  Purpose:
    - Inline editor for a single TargetDataset technical name
    - Uses HTMX to trigger dry-run/commit via targetdataset_rename endpoint
-->

{% with schema_short=ds.target_schema.short_name dataset_name=ds.target_dataset_name %}
  {% if schema_short == "raw" or schema_short == "stage" or schema_short == "rawcore" and dataset_name|slice:"-5:" == "_hist" %}
    <div id="tds-cell-{{ ds.id }}" class="form-control-plaintext d-flex align-items-center gap-1">
      <span>{{ ds.target_dataset_name }}</span>
      <i class="bi bi-ban text-muted" title="System-managed: rename not allowed"></i>
    </div>
  {% else %}
    <div id="tds-cell-{{ ds.id }}" class="tds-cell">
      <form
        hx-post="{% url 'api_targetdataset_rename' pk=ds.id %}"
        hx-target="#tds-preview-{{ ds.id }}"
        hx-swap="innerHTML"
        hx-trigger="keyup changed delay:400ms"
      >
        {% csrf_token %}
        <input
          type="text"
          name="target_dataset_name"
          value="{{ ds.target_dataset_name }}"
          class="form-control form-control-sm"
          placeholder="dataset_name"
          aria-label="Rename dataset"
          onkeydown="
            if (event.key === 'Enter') {
              const cell = this.closest('.tds-cell');  // <<< HIER
              if (!cell) return;
              const applyForm = cell.querySelector('form[data-role=&quot;tc-rename-apply&quot;]');
              if (applyForm) {
                event.preventDefault();
                if (applyForm.requestSubmit) {
                  applyForm.requestSubmit();
                } else {
                  applyForm.submit();
                }
              }
            }
          "
        />
        <input type="hidden" name="dry_run" value="true" />
      </form>

      <div id="tds-preview-{{ ds.id }}" class="mt-1">
        <!-- HTMX injects _targetdataset_inline_preview.html here -->
      </div>
    </div>
  {% endif %}
{% endwith %}
