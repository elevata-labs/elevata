<!--
elevata - Metadata-driven Data Platform Framework
Copyright © 2025 Ilona Tag

This file is part of elevata.

elevata is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as
published by the Free Software Foundation, either version 3 of
the License, or (at your option) any later version.

elevata is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with elevata. If not, see <https://www.gnu.org/licenses/>.

Contact: <https://github.com/elevata-labs/elevata>.
-->

{% extends "base.html" %}
{% load attr support_extras %}

{% block title %}{{ object }} · elevata{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <div class="d-flex align-items-center gap-2 flex-wrap">
    <h1 class="h4 mb-0">{{ title|default:object }}</h1>

    {% if object %}
      {% if model_name == 'system' or model_name == 'sourcedataset' or model_name == 'sourcedatasetgroup' or model_name == 'targetdataset' %}
        {# WICHTIG: kein mb-3; nur ein kleiner linker Abstand zum Titel #}
        <nav class="subnav ms-2">
          {% if model_name == 'system' and object.is_source %}
            <a href="{% url 'sourcedataset_list' object.pk %}" class="btn btn-sm btn-outline-primary">
              <i class="bi bi-table"></i> Datasets
            </a>
          {% elif model_name == 'sourcedataset' %}
            <a href="{% url 'sourcecolumn_list' object.pk %}" class="btn btn-sm btn-outline-primary">
              <i class="bi bi-columns"></i> Columns
            </a>
            <a href="{% url 'sourcedatasetownership_list' object.pk %}" class="btn btn-sm btn-outline-primary">
              <i class="bi bi-person-badge"></i> Ownership
            </a>
            <a href="{% url 'sourcedatasetincrementpolicy_list' object.pk %}" class="btn btn-sm btn-outline-primary">
              <i class="bi bi-clock-history"></i> Increment policy
            </a>
          {% elif model_name == 'sourcedatasetgroup' %}
            <a href="{% url 'sourcedatasetgroupmembership_list' object.pk %}" class="btn btn-sm btn-outline-primary">
              <i class="bi bi-diagram-3"></i> Memberships
            </a>
          {% elif model_name == 'targetdataset' %}
            <a href="{% url 'targetdatasetinput_list' object.pk %}" class="btn btn-sm btn-outline-primary">
              <i class="bi bi-box-arrow-in-right"></i> Inputs
            </a>
            <a href="{% url 'targetcolumn_list' object.pk %}" class="btn btn-sm btn-outline-primary">
              <i class="bi bi-columns"></i> Columns
            </a>
            <a href="{% url 'targetdatasetreference_list' object.pk %}" class="btn btn-sm btn-outline-primary">
              <i class="bi bi-link-45deg"></i> References
            </a>
            <a href="{% url 'targetdatasetownership_list' object.pk %}" class="btn btn-sm btn-outline-primary">
              <i class="bi bi-person-badge"></i> Ownership
            </a>
            <a href="{% url 'targetdataset_lineage' object.pk %}" class="btn btn-sm btn-outline-primary">
              <i class="bi bi-diagram-3"></i> Lineage
            </a>
          {% endif %}
        </nav>
      {% endif %}
    {% endif %}

    <!-- Summary badges for SourceColumn -->
    {% if object and model_name == 'sourcecolumn' %}
      {% if object.primary_key_column %}
        <span class="ec-chip ec-chip--pk ms-2" title="Primary key">PK</span>
      {% endif %}
    {% endif %}
  </div>

  <!-- top-align back button -->
  <a class="btn btn-secondary btn-sm d-flex align-self-start" href="{% url model_name|add:'_list' %}">
    <i class="bi bi-arrow-left"></i> Back
  </a>
</div>

  <table class="table table-striped align-middle mb-4">
    <tbody>
      {% for field in fields %}
        <tr>
          <th style="width: 25%;">{{ field.verbose_name|capfirst }}</th>

          <!-- Special rendering for 'type' with dialect badge + hint -->
          {% if field.name == "type" %}
            <td>
              {{ object|attr:field.name }}
              {% if model_name == 'system' and object.is_source %}
                {% with level=object.type|support_level %}
                  <span class="badge {{ level|support_badge_class }} ms-1">
                    {{ level|support_label }}
                  </span>
                {% endwith %}
              {% endif %}

              <div id="type-hint"
                   class="small text-muted mt-1"
                   hx-get="{% url 'source_type_hint' %}"
                   hx-trigger="load"
                   hx-vals='{"type":"{{ object.type|default_if_none:"" }}"}'>
              </div>
            </td>

          {% else %}
            <td>{{ object|attr:field.name }}</td>
          {% endif %}
        </tr>
      {% endfor %}

      {% for field in many_to_many %}
        <tr>
          <th style="width: 25%;">{{ field.verbose_name|capfirst }}</th>
          <td>
            {% with rel_mgr=object|attr:field.name %}
              {% for rel_obj in rel_mgr.all %}
                {{ rel_obj }}{% if not forloop.last %}, {% endif %}
              {% empty %}
                <span class="text-muted">–</span>
              {% endfor %}
            {% endwith %}
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Import button for SourceDataset detail -->
  {% if object and model_name == 'sourcedataset' %}
    <hr>
    {% if object.source_system.is_source and object.source_system.type|is_import_supported %}
      <form class="mt-3 d-inline">
        {% csrf_token %}
        <label class="me-2">
          <input type="checkbox" name="autointegrate_pk" checked> auto-integrate PK
        </label>
        <label class="me-2">
          <input type="checkbox" name="reset_flags"> reset flags
        </label>

        <button
          type="button"
          class="btn btn-primary hx-trigger-btn"
          hx-post="{% url 'sourcedataset_import_metadata' object.id %}"
          hx-include="closest form"
          hx-target="#feedback-{{ object.id }}"
          hx-swap="innerHTML"
          hx-on::before-request="this.setAttribute('disabled','disabled')"
          hx-on::after-request="this.removeAttribute('disabled')"
          hx-indicator="#loading-dataset-{{ object.id }}"
        >
          <i class="bi bi-arrow-repeat"></i>
          Import metadata
        </button>
      </form>

      <!-- Indicator for this dataset import -->
      <div id="loading-dataset-{{ object.id }}"
           class="htmx-indicator mt-2"
           style="display:none;">
        <div class="spinner-border spinner-border-sm text-info me-2" role="status"></div>
        <span class="text-muted small">Import running, please wait …</span>
      </div>

      <!-- Import result -->
      <div id="feedback-{{ object.id }}" class="mt-2"></div>

    {% elif not object.source_system.is_source %}
      <div class="alert alert-secondary mt-3 mb-0">
        This system is not marked as a source (is_source = False) — automated metadata import
        is only available for source systems.
      </div>
    {% else %}
      <div class="alert alert-secondary mt-3 mb-0">
        Manual source type — automated import is not available for
        <strong>{{ object.source_system.type }}</strong>.
      </div>
    {% endif %}
  {% endif %}
  <!-- Import button for System detail -->
  {% if object and model_name == 'system' %}
    <hr>
    {% if object.is_source and object.type|is_import_supported %}
      <form class="mt-3 d-inline">
        {% csrf_token %}
        <label class="me-2">
          <input type="checkbox" name="autointegrate_pk" checked> auto-integrate PK
        </label>
        <label class="me-2">
          <input type="checkbox" name="reset_flags"> reset flags
        </label>

        <button
          type="button"
          class="btn btn-primary hx-trigger-btn"
          hx-post="{% url 'sourcesystem_import_metadata' object.id %}"
          hx-include="closest form"
          hx-target="#system-feedback"
          hx-swap="innerHTML"
          hx-on::before-request="this.setAttribute('disabled','disabled')"
          hx-on::after-request="this.removeAttribute('disabled')"
          hx-indicator="#loading-system-{{ object.id }}"
        >
          <i class="bi bi-arrow-repeat"></i>
          Import metadata for all datasets
        </button>
      </form>

      <!-- Indicator for this system import -->
      <div id="loading-system-{{ object.id }}"
           class="htmx-indicator mt-2"
           style="display:none;">
        <div class="spinner-border spinner-border-sm text-info me-2" role="status"></div>
        <span class="text-muted small">Import running, please wait …</span>
      </div>

      <!-- Import result -->
      <div id="system-feedback" class="mt-3"></div>
    {% elif not object.is_source %}
      <div class="alert alert-secondary mt-3 mb-0">
        This system is not marked as a source (is_source = False) — automated metadata import
        is only available for source systems.
      </div>
    {% else %}
      <div class="alert alert-secondary mt-3 mb-0">
        Manual source type — automated import is not available for
        <strong>{{ object.type }}</strong>.
      </div>
    {% endif %}
  {% endif %}

  <!-- SQL Preview for TargetDataset detail -->
  {% if object and model_name == 'targetdataset' %}
    <hr>

    <div class="mt-3 d-flex flex-wrap gap-2">

      <!-- Full SQL -->
      <button
        type="button"
        class="btn btn-primary btn-sm"
        hx-get="{% url 'targetdataset_sql_preview' object.id %}"
        hx-target="#sql-preview"
        hx-swap="innerHTML"
        hx-on::before-request="this.setAttribute('disabled','disabled')"
        hx-on::after-request="this.removeAttribute('disabled')"
        hx-indicator="#loading-sql-{{ object.id }}"
      >
        <i class="bi bi-infinity"></i>
        Full SQL
      </button>

      <!-- MERGE SQL -->
      <button
        type="button"
        class="btn btn-primary btn-sm"
        {% if not object.is_incremental or object.incremental_strategy != 'merge' %}disabled{% endif %}
        hx-get="{% url 'targetdataset_merge_sql_preview' object.id %}"
        hx-target="#sql-preview"
        hx-swap="innerHTML"
        hx-on::before-request="this.setAttribute('disabled','disabled')"
        hx-on::after-request="this.removeAttribute('disabled')"
        hx-indicator="#loading-sql-{{ object.id }}"
      >
        <i class="bi bi-diagram-3"></i>
        Incremental MERGE
      </button>

      <!-- DELETE detect SQL -->
      <button
        type="button"
        class="btn btn-primary btn-sm"
        {% if not object.is_incremental or not object.handle_deletes %}disabled{% endif %}
        hx-get="{% url 'targetdataset_delete_sql_preview' object.id %}"
        hx-target="#sql-preview"
        hx-swap="innerHTML"
        hx-on::before-request="this.setAttribute('disabled','disabled')"
        hx-on::after-request="this.removeAttribute('disabled')"
        hx-indicator="#loading-sql-{{ object.id }}"
      >
        <i class="bi bi-trash3"></i>
        Delete Detection
      </button>

      <!-- Loading indicator -->
      <div id="loading-sql-{{ object.id }}"
          class="htmx-indicator mt-2"
          style="display:none;">
        <div class="spinner-border spinner-border-sm text-info me-2" role="status"></div>
        <span class="text-muted small">Building SQL …</span>
      </div>
    </div>

    <div id="sql-preview" class="mt-3"></div>
  {% endif %}

  {% if related_objects %}
    <h5 class="mt-4 mb-3">Related Data</h5>
    {% for label, items in related_objects %}
      <div class="mb-3">
        <strong>{{ label }}</strong>
        {% if items %}
          <ul class="mb-0">
            {% for item in items %}
              <li>{{ item }}</li>
            {% empty %}
              <li><em>No related records</em></li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted mb-0">–</p>
        {% endif %}
      </div>
    {% endfor %}
  {% endif %}
{% endblock %}
