<!--
elevata - Metadata-driven Data Platform Framework
Copyright © 2025-2026 Ilona Tag

This file is part of elevata.

elevata is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as
published by the Free Software Foundation, either version 3 of
the License, or (at your option) any later version.

elevata is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with elevata. If not, see <https://www.gnu.org/licenses/>.

Contact: <https://github.com/elevata-labs/elevata>.
-->

{% extends "base.html" %}
{% load attr %}
{% load support_extras %}

{% block title %}{{ title }} · elevata{% endblock %}

{% block content %}

  {% if scoped_parent_label %}
    <div class="mb-1 small text-muted">
      {% if scoped_parent_url %}
        <a href="{{ scoped_parent_url }}" class="text-decoration-none">
          <i class="bi bi-arrow-left"></i> {{ scoped_parent_label }}
        </a>
      {% else %}
        <i class="bi bi-arrow-left"></i> {{ scoped_parent_label }}
      {% endif %}
    </div>
  {% endif %}

  <div class="d-flex align-items-center justify-content-between mb-3">
    <div class="d-flex align-items-center gap-2">
      <h1 class="h4 mb-0">{{ title }}</h1>

      {% include "metadata/partials/_union_toolbar.html" %}

      {% if model_name == "querywindowcolumn" and scoped_query_dataset_pk %}
        <a
          href="{% url 'orderbyexpression_list' scoped_query_dataset_pk %}"
          class="btn btn-primary btn-sm d-inline-flex align-items-center gap-1"
          title="Define reusable ORDER BY clauses"
        >
          <i class="bi bi-sort-down"></i>
          Create order by
        </a>
        <a
          href="{% url 'partitionbyexpression_list' scoped_query_dataset_pk %}"
          class="btn btn-primary btn-sm d-inline-flex align-items-center gap-1"
          title="Define reusable PARTITION BY clauses"
        >
          <i class="bi bi-layout-three-columns"></i>
          Create partition by
        </a>
      {% endif %}
    </div>

    <!-- Inline-create: inject a new row form at the top of the grid -->
    <!-- figure out the correct "new row" URL -->
    {% if parent_pk %}
      {% url model_name|add:'_row_new' parent_pk as new_url %}
    {% else %}
      {% url model_name|add:'_row_new' as new_url %}
    {% endif %}

    <div class="d-flex align-items-center gap-2">
      {% if scoped_parent_is_query_builder and scoped_parent_url %}
        <a
          href="{{ scoped_parent_url }}"
          class="btn btn-outline-secondary btn-sm d-inline-flex align-items-center gap-1"
          title="Back to Query Builder"
        >
          <i class="bi bi-compass"></i>
          Query builder
        </a>
      {% endif %}

      <!-- Only show global Generate Targets action on SourceDataset list -->
      {% if model_name == "sourcedataset" %}
        <button
          type="button"
          class="btn btn-primary btn-sm d-flex align-items-center gap-1"
          hx-post="{% url 'generate_targets' %}"
          hx-target="#grid-feedback"
          hx-swap="innerHTML"
          hx-confirm="Generate Targets for all eligible source datasets and layers?"
          hx-indicator="#generation-loading"
          hx-on::before-request="this.setAttribute('disabled','disabled')"
          hx-on::after-request="this.removeAttribute('disabled')"
        >
          <i class="bi bi-lightning-charge"></i>
          Generate Targets
        </button>
      {% endif %}

      <button
        class="btn btn-primary btn-sm d-flex align-items-center gap-1"
        hx-get="{{ new_url }}"
        hx-target="#grid-body"
        hx-swap="afterbegin">
        <i class="bi bi-plus"></i>
        Add
      </button>
    </div>
  </div>

  <!-- UNION validation panel target (used by toolbar HTMX validate button) -->
  {% if union_parent_pk and model_name == "queryunionbranch" %}
    <div id="union-validation-panel" class="mb-2"></div>
  {% elif union_parent_pk and model_name == "queryunionoutputcolumn" %}
    <div id="union-validation-panel" class="mb-2"></div>
  {% elif union_parent_pk and model_name == "queryunionbranchmapping" %}
    <div id="union-validation-panel" class="mb-2"></div>
  {% endif %}

  <div class="d-flex align-items-center justify-content-end gap-2 mb-2">
    <div id="generation-loading"
        class="htmx-indicator d-flex align-items-center gap-2"
        style="display:none;">
      <div class="spinner-border spinner-border-sm text-info" role="status"></div>
      <span class="text-muted small">Generating targets…</span>
    </div>

    <div id="grid-feedback" class="small text-muted text-end"></div>
  </div>

  <!-- Inline warnings/errors for row editors (left aligned, full width) -->
  <div id="grid-feedback-inline" class="w-100 text-start mb-2"></div>  

  <!-- Filter form: auto-generated from auto_filter_cfgs -->
  {% if auto_filter_cfgs %}
    <form method="get"
          class="row g-2 align-items-end mb-3 border rounded p-2 bg-light">

      {% for fcfg in auto_filter_cfgs %}
        {% with field_path=fcfg.field_path %}
        {% with param_name="filter__"|add:field_path %}
          <div class="col-auto">
            <label class="form-label small mb-1">{{ fcfg.label }}</label>

            {% if fcfg.input_type == "text" %}
              <input type="text" class="form-control form-control-sm"
                     name="{{ param_name }}"
                     value="{{ active_filters|get:param_name|default:'' }}">
            {% endif %}

            {% if fcfg.input_type == "number" %}
              <input type="number" class="form-control form-control-sm"
                     name="{{ param_name }}"
                     value="{{ active_filters|get:param_name|default:'' }}">
            {% endif %}

            {% if fcfg.input_type == "boolean" %}
              <select class="form-select form-select-sm" name="{{ param_name }}">
                <option value="">-- any --</option>
                <option value="1"
                  {% if active_filters|get:param_name == "1" %}selected{% endif %}>Yes</option>
                <option value="0"
                  {% if active_filters|get:param_name == "0" %}selected{% endif %}>No</option>
              </select>
            {% endif %}

            {% if fcfg.input_type == "choice" %}
              <select class="form-select form-select-sm" name="{{ param_name }}">
                <option value="">-- any --</option>
                {% for pair in fcfg.choices %}
                  {% with opt_val=pair.0 opt_label=pair.1 %}
                    <option value="{{ opt_val }}"
                      {% if active_filters|get:param_name == opt_val %}selected{% endif %}>
                      {{ opt_label }}
                    </option>
                  {% endwith %}
                {% endfor %}
              </select>
            {% endif %}

            {% if fcfg.input_type == "foreignkey" %}
              <select class="form-select form-select-sm" name="{{ param_name }}">
                <option value="">-- any --</option>
                {% for pair in fcfg.choices %}
                  {% with opt_val=pair.0 opt_label=pair.1 %}
                    <option value="{{ opt_val }}"
                      {% if active_filters|get:param_name == opt_val %}selected{% endif %}>
                      {{ opt_label }}
                    </option>
                  {% endwith %}
                {% endfor %}
              </select>
            {% endif %}
          </div>
        {% endwith %}
        {% endwith %}
      {% endfor %}

      <div class="col-auto">
        <button class="btn btn-primary btn-sm" type="submit">Apply</button>
        <a class="btn btn-outline-secondary btn-sm" href=".">Clear</a>
      </div>

    </form>
  {% endif %}

  <!-- Scroll container for table with sticky header -->
  <div style="max-height: 70vh; overflow-y: auto;">
    <table class="table table-striped table-hover align-middle table-fixed-header">
      <thead class="table-light">
        <tr>
          {% for f in fields %}
            <th scope="col">
              {{ f.verbose_name|capfirst }}
              {% if model_name == "targetcolumn" and f.name == "target_column_name" %}
                <div class="form-text">
                  Type to check. Apply to commit.
                </div>
              {% elif model_name == "targetdataset" and f.name == "target_dataset_name" %}
                <div class="form-text">
                  Type to check. Apply to commit.
                </div>
              {% endif %}
            </th>
          {% endfor %}

          <!-- header for badges -->
          {% with model_badges=BADGE_CLASSES|get:model_class_name %}
            {% if model_badges %}
              <th scope="col" class="text-center" title="Governance attributes">
                <i class="bi bi-tags-fill"></i>
              </th>
            {% endif %}
          {% endwith %}

          <th scope="col" class="text-end text-nowrap" style="width: 120px;">Actions</th>
        </tr>
      </thead>

      <tbody id="grid-body">
        {% for obj in objects %}
          {% include "generic/row.html" with object=obj model=model meta=meta fields=fields model_name=model_name parent_pk=parent_pk %}
        {% empty %}
          <tr id="no-records-row">
            <td colspan="99" class="text-center text-muted py-4">No records found.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

<script>
  function elevataSyncEmptyPlaceholder() {
    const gridBody = document.getElementById("grid-body");
    if (!gridBody) return;

    // Alle Datensätze identifizieren: <tr id="row-123">
    const realRows = Array.from(gridBody.querySelectorAll("tr"))
      .filter(tr => tr.id && tr.id.startsWith("row-"));

    const hasRealRows = realRows.length > 0;
    let emptyRow = document.getElementById("no-records-row");

    if (hasRealRows) {
      // Falls wir Datensätze haben -> Placeholder entfernen, wenn vorhanden
      if (emptyRow) {
        emptyRow.remove();
      }
    } else {
      // Falls wir KEINE Datensätze mehr haben -> Placeholder einfügen, falls nicht schon da
      if (!emptyRow) {
        emptyRow = document.createElement("tr");
        emptyRow.id = "no-records-row";

        const cell = document.createElement("td");
        cell.colSpan = "99";
        cell.className = "text-center text-muted py-4";
        cell.textContent = "No records found.";

        emptyRow.appendChild(cell);
        gridBody.appendChild(emptyRow);
      }
    }
  }
</script>

{% endblock %}
